{% extends "dashboard.html" %}



{% block content %}

<div class="container-fluid p-0">
    <div class="row mb-2 mb-xl-3">
        <div class="col-auto d-none d-sm-block">
            <h1 class="h3 mb-3"><strong>Contacts</strong> Management</h1>
        </div>

        <div class="col-auto ms-auto text-end mt-n1">
            <a href="{{ url_for('contact.add_page') }}" class="btn btn-primary">
                <i class="align-middle" data-feather="user-plus"></i> Add Contact
            </a>
            <a href="{{ url_for('contact.import_page') }}" class="btn btn-light">
                <i class="align-middle" data-feather="upload"></i> Import
            </a>
            <div class="dropdown d-inline-block">
                <button class="btn btn-light dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="align-middle" data-feather="download"></i> Export
                </button>
                <ul class="dropdown-menu" aria-labelledby="exportDropdown">
                    <li><a class="dropdown-item" href="{{ url_for('contact.export_contacts', format='csv') }}">CSV</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('contact.export_contacts', format='xml') }}">XML</a></li>
                </ul>
            </div>
            <a href="{{ url_for('contact.groups') }}" class="btn btn-light">
                <i class="align-middle" data-feather="users"></i> Manage Groups
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-12 col-lg-8 col-xxl-9 d-flex">
            <div class="card flex-fill">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Contact List</h5>
                        <div class="d-flex">
                            <div class="input-group me-2">
                                <input type="text" class="form-control" id="contactSearch" placeholder="Search contacts...">
                                <button class="btn btn-outline-secondary" type="button" id="searchButton">
                                    <i class="align-middle" data-feather="search"></i>
                                </button>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="groupFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    All Groups
                                </button>
                                <ul class="dropdown-menu" id="groupFilterMenu" aria-labelledby="groupFilterDropdown">
                                    <li><a class="dropdown-item active" href="#" data-group="all">All Groups</a></li>
                                    <!-- Groups will be loaded dynamically -->
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover my-0" id="contactsTable">
                            <thead>
                                <tr>
                                    <th>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="selectAllContacts">
                                            <label class="form-check-label" for="selectAllContacts"></label>
                                        </div>
                                    </th>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th>Group</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for contact in contacts.items %}
                                <tr data-contact-id="{{ contact.id }}">
                                    <td>
                                        <div class="form-check">
                                            <input class="form-check-input contact-checkbox" type="checkbox" value="{{ contact.id }}">
                                            <label class="form-check-label"></label>
                                        </div>
                                    </td>
                                    <td>{{ contact.name }}</td>
                                    <td>{{ contact.phone }}</td>
                                    <td>{{ contact.email or '-' }}</td>
                                    <td><span class="badge bg-primary">{{ contact.group or 'default' }}</span></td>
                                    <td>
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-outline-primary edit-contact" data-contact-id="{{ contact.id }}">
                                                <i data-feather="edit-2"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger delete-contact" data-contact-id="{{ contact.id }}">
                                                <i data-feather="trash"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-success send-message" data-contact-id="{{ contact.id }}" data-contact-name="{{ contact.name }}" data-contact-phone="{{ contact.phone }}">
                                                <i data-feather="message-square"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="6" class="text-center">No contacts found</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer d-flex justify-content-between align-items-center">
                    <div>
                        <button id="bulkDeleteBtn" class="btn btn-sm btn-danger" disabled>
                            <i class="align-middle" data-feather="trash-2"></i> Delete Selected
                        </button>
                        <div class="dropdown d-inline-block">
                            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="bulkActionDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                Bulk Actions
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="bulkActionDropdown">
                                <li><a class="dropdown-item" href="#" id="bulkExport">Export Selected</a></li>
                                <li><a class="dropdown-item" href="#" id="bulkAssignGroup">Assign to Group</a></li>
                                <li><a class="dropdown-item" href="#" id="bulkRemoveFromGroup">Remove from Group</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" id="bulkSendMessage">Send Message</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header">Group Actions</h6></li>
                                <li><a class="dropdown-item" href="#" id="bulkDeleteByGroup">Delete by Group</a></li>
                                <li><a class="dropdown-item" href="#" id="bulkExportByGroup">Export by Group</a></li>
                                <li><a class="dropdown-item" href="#" id="bulkSendMessageByGroup">Message by Group</a></li>
                            </ul>
                        </div>
                    </div>
                    <nav>
                        <ul class="pagination mb-0">
                            {% if contacts.has_prev %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('contact.index', page=contacts.prev_num) }}">&laquo;</a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <a class="page-link" href="#">&laquo;</a>
                            </li>
                            {% endif %}
                            
                            {% for page_num in contacts.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                                {% if page_num %}
                                    {% if contacts.page == page_num %}
                                    <li class="page-item active">
                                        <a class="page-link" href="{{ url_for('contact.index', page=page_num) }}">{{ page_num }}</a>
                                    </li>
                                    {% else %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('contact.index', page=page_num) }}">{{ page_num }}</a>
                                    </li>
                                    {% endif %}
                                {% else %}
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#">...</a>
                                    </li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if contacts.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('contact.index', page=contacts.next_num) }}">&raquo;</a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <a class="page-link" href="#">&raquo;</a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-4 col-xxl-3 d-flex">
            <div class="card flex-fill">
                <div class="card-header">
                    <h5 class="card-title mb-0">Contact Groups</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-3">
                        <i class="align-middle" data-feather="info"></i>
                        <p><strong>Important:</strong> Group management has been moved to the dedicated Groups page.</p>
                        <p>To add, edit, or delete groups, please use the <a href="{{ url_for('contact.groups') }}">Groups page</a>.</p>
                        <p>Do not attempt to add groups from this page.</p>
                    </div>
                    <div class="d-grid gap-2 mb-3">
                        <a href="{{ url_for('contact.groups') }}" class="btn btn-primary">
                            <i class="align-middle" data-feather="users"></i> Manage Groups
                        </a>
                    </div>
                    <div class="list-group" id="groupsList">
                        <!-- Groups will be loaded dynamically -->
                        <div class="text-center py-3" id="groupsLoading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <!-- Server-side rendered groups as fallback -->
                        {% if groups %}
                            {% for group in groups %}
                                <a href="{{ url_for('contact.groups') }}?group={{ group.name }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                    {{ group.name }}
                                    <span class="badge bg-primary rounded-pill">{{ group.count }}</span>
                                </a>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Contact Modal removed - now using dedicated page -->

<!-- Edit Contact Modal removed - now using dedicated page -->

<!-- Add Group Modal removed - now using dedicated page at templates/contacts/groups.html -->

<!-- Assign to Group Modal removed - now using dedicated page at templates/contacts/groups.html -->

<!-- SweetAlert2 script -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Feather icons
        feather.replace();
        
        // Load contact groups
        loadGroups();
        
        // Handle select all checkbox
        document.getElementById('selectAllContacts').addEventListener('change', function() {
            const isChecked = this.checked;
            document.querySelectorAll('.contact-checkbox').forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            updateBulkActionButtons();
        });
        
        // Handle individual contact checkboxes
        document.querySelectorAll('.contact-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', updateBulkActionButtons);
        });
        
        // Handle edit contact button clicks
        document.querySelectorAll('.edit-contact').forEach(button => {
            button.addEventListener('click', function() {
                const contactId = this.getAttribute('data-contact-id');
                openEditContactModal(contactId);
            });
        });
        
        // Handle delete contact button clicks
        document.querySelectorAll('.delete-contact').forEach(button => {
            button.addEventListener('click', function() {
                const contactId = this.getAttribute('data-contact-id');
                openDeleteConfirmModal(contactId);
            });
        });
        
        // Handle send message button clicks
        document.querySelectorAll('.send-message').forEach(button => {
            button.addEventListener('click', function() {
                const contactId = this.getAttribute('data-contact-id');
                const contactName = this.getAttribute('data-contact-name');
                const contactPhone = this.getAttribute('data-contact-phone');
                openSendMessageModal(contactId, contactName, contactPhone);
            });
        });
        
        // Handle bulk delete button
        document.getElementById('bulkDeleteBtn').addEventListener('click', function() {
            const selectedContacts = getSelectedContactIds();
            if (selectedContacts.length > 0) {
                Swal.fire({
                    title: 'Confirm Bulk Deletion',
                    text: `Are you sure you want to delete ${selectedContacts.length} contacts? This action cannot be undone.`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Delete All',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        bulkDeleteContacts(selectedContacts);
                    }
                });
            }
        });
        
        // Handle bulk export button
        document.getElementById('bulkExport').addEventListener('click', function() {
            const selectedContacts = getSelectedContactIds();
            if (selectedContacts.length > 0) {
                Swal.fire({
                    title: 'Export Selected Contacts',
                    html: `
                        <p>Select export format for ${selectedContacts.length} contacts:</p>
                        <div class="btn-group w-100 mt-3">
                            <button type="button" class="btn btn-primary" id="exportCsvBtn">CSV</button>
                            <button type="button" class="btn btn-primary" id="exportXmlBtn">XML</button>
                        </div>
                    `,
                    showConfirmButton: false,
                    showCancelButton: true,
                    cancelButtonText: 'Cancel',
                    cancelButtonColor: '#6c757d'
                });
                
                // Add event listeners to the export format buttons
                document.getElementById('exportCsvBtn').addEventListener('click', function() {
                    exportSelectedContacts(selectedContacts, 'csv');
                    Swal.close();
                });
                
                document.getElementById('exportXmlBtn').addEventListener('click', function() {
                    exportSelectedContacts(selectedContacts, 'xml');
                    Swal.close();
                });
            }
        });
        
        // Handle bulk assign to group button
        document.getElementById('bulkAssignGroup').addEventListener('click', function() {
            const selectedContacts = getSelectedContactIds();
            if (selectedContacts.length > 0) {
                // Fetch available groups
                fetch('{{ url_for("contact.api_list_groups") }}')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Create group options HTML
                        let groupOptionsHtml = '';
                        data.groups.forEach(group => {
                            groupOptionsHtml += `<option value="${group.name}">${group.name}</option>`;
                        });
                        
                        // Show group selection dialog
                        Swal.fire({
                            title: 'Assign to Group',
                            html: `
                                <p>Select a group to assign ${selectedContacts.length} contacts:</p>
                                <select class="form-select mb-3" id="groupSelect">
                                    ${groupOptionsHtml}
                                </select>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="createNewGroup">
                                    <label class="form-check-label" for="createNewGroup">Create new group</label>
                                </div>
                                <div id="newGroupNameContainer" style="display: none;">
                                    <input type="text" class="form-control" id="newGroupName" placeholder="Enter new group name">
                                </div>
                            `,
                            showCancelButton: true,
                            confirmButtonText: 'Assign',
                            cancelButtonText: 'Cancel',
                            confirmButtonColor: '#198754',
                            cancelButtonColor: '#6c757d',
                            preConfirm: () => {
                                const createNew = document.getElementById('createNewGroup').checked;
                                if (createNew) {
                                    const newGroupName = document.getElementById('newGroupName').value.trim();
                                    if (!newGroupName) {
                                        Swal.showValidationMessage('Please enter a group name');
                                        return false;
                                    }
                                    return { createNew: true, groupName: newGroupName };
                                } else {
                                    const groupSelect = document.getElementById('groupSelect');
                                    return { createNew: false, groupName: groupSelect.value };
                                }
                            }
                        }).then((result) => {
                            if (result.isConfirmed) {
                                const { createNew, groupName } = result.value;
                                
                                // If creating a new group, create it first
                                if (createNew) {
                                    fetch('{{ url_for("contact.api_add_group") }}', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({ name: groupName })
                                    })
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.success) {
                                            // Now assign contacts to the new group
                                            assignContactsToGroup(selectedContacts, groupName);
                                        } else {
                                            Swal.fire('Error', data.error || 'Failed to create group', 'error');
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error:', error);
                                        Swal.fire('Error', 'An error occurred while creating the group', 'error');
                                    });
                                } else {
                                    // Assign contacts to existing group
                                    assignContactsToGroup(selectedContacts, groupName);
                                }
                            }
                        });
                        
                        // Toggle new group name input based on checkbox
                        document.getElementById('createNewGroup').addEventListener('change', function() {
                            document.getElementById('newGroupNameContainer').style.display = this.checked ? 'block' : 'none';
                            document.getElementById('groupSelect').disabled = this.checked;
                        });
                    } else {
                        Swal.fire('Error', data.error || 'Failed to load groups', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire('Error', 'An error occurred while loading groups', 'error');
                });
            }
        });
        
        // Handle bulk remove from group button
        document.getElementById('bulkRemoveFromGroup').addEventListener('click', function() {
            const selectedContacts = getSelectedContactIds();
            if (selectedContacts.length > 0) {
                Swal.fire({
                    title: 'Remove from Group',
                    text: `Are you sure you want to remove ${selectedContacts.length} contacts from their current groups?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Remove',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Assign to 'default' group (effectively removing from current group)
                        assignContactsToGroup(selectedContacts, 'default');
                    }
                });
            }
        });
        
        // Handle bulk send message button
        document.getElementById('bulkSendMessage').addEventListener('click', function() {
            const selectedContacts = getSelectedContactIds();
            if (selectedContacts.length > 0) {
                sendMessageToSelectedContacts(selectedContacts);
            } else {
                Swal.fire('Info', 'Please select at least one contact.', 'info');
            }
        });
        
        // Handle bulk send message by group button
        document.getElementById('bulkSendMessageByGroup').addEventListener('click', function() {
            // Fetch available groups
            fetch('{{ url_for("contact.api_list_groups") }}')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Create group options HTML
                    let groupOptionsHtml = '';
                    data.groups.forEach(group => {
                        groupOptionsHtml += `<option value="${group.name}">${group.name} (${group.contact_count || 0} contacts)</option>`;
                    });
                    
                    // Show group selection dialog
                    Swal.fire({
                        title: 'Send Message to Group',
                        html: `
                            <p>Select a group to send message to:</p>
                            <select class="form-select mb-3" id="groupSelectMessage">
                                ${groupOptionsHtml}
                            </select>
                        `,
                        showCancelButton: true,
                        confirmButtonText: 'Send',
                        cancelButtonText: 'Cancel',
                        confirmButtonColor: '#198754',
                        cancelButtonColor: '#6c757d',
                        preConfirm: () => {
                            const groupSelect = document.getElementById('groupSelectMessage');
                            return groupSelect.value;
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            sendMessageToGroup(result.value);
                        }
                    });
                } else {
                    Swal.fire('Error', data.error || 'Failed to load groups', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'An error occurred while loading groups', 'error');
            });
        });
        
        // Handle bulk delete by group button
        document.getElementById('bulkDeleteByGroup').addEventListener('click', function() {
            // Fetch available groups
            fetch('{{ url_for("contact.api_list_groups") }}')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Create group options HTML
                    let groupOptionsHtml = '';
                    data.groups.forEach(group => {
                        groupOptionsHtml += `<option value="${group.name}">${group.name} (${group.contact_count} contacts)</option>`;
                    });
                    
                    // Show group selection dialog
                    Swal.fire({
                        title: 'Delete Contacts by Group',
                        html: `
                            <p>Select a group to delete all contacts from:</p>
                            <select class="form-select mb-3" id="groupSelectDelete">
                                ${groupOptionsHtml}
                            </select>
                            <div class="alert alert-warning">
                                <i class="align-middle" data-feather="alert-triangle"></i>
                                This action will delete ALL contacts in the selected group and cannot be undone.
                            </div>
                        `,
                        showCancelButton: true,
                        confirmButtonText: 'Delete',
                        cancelButtonText: 'Cancel',
                        confirmButtonColor: '#dc3545',
                        cancelButtonColor: '#6c757d',
                        didOpen: () => {
                            feather.replace();
                        },
                        preConfirm: () => {
                            const groupSelect = document.getElementById('groupSelectDelete');
                            return groupSelect.value;
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            const groupName = result.value;
                            deleteContactsByGroup(groupName);
                        }
                    });
                } else {
                    Swal.fire('Error', 'Failed to load groups', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'An error occurred while loading groups', 'error');
            });
        });
        
        // Handle bulk export by group button
        document.getElementById('bulkExportByGroup').addEventListener('click', function() {
            // Fetch available groups
            fetch('{{ url_for("contact.api_list_groups") }}')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Create group options HTML
                    let groupOptionsHtml = '';
                    data.groups.forEach(group => {
                        groupOptionsHtml += `<option value="${group.name}">${group.name} (${group.contact_count} contacts)</option>`;
                    });
                    
                    // Show group selection dialog
                    Swal.fire({
                        title: 'Export Contacts by Group',
                        html: `
                            <p>Select a group to export all contacts from:</p>
                            <select class="form-select mb-3" id="groupSelectExport">
                                ${groupOptionsHtml}
                            </select>
                            <p>Select export format:</p>
                            <div class="btn-group w-100">
                                <input type="radio" class="btn-check" name="exportFormat" id="exportFormatCsv" value="csv" checked>
                                <label class="btn btn-outline-primary" for="exportFormatCsv">CSV</label>
                                <input type="radio" class="btn-check" name="exportFormat" id="exportFormatXml" value="xml">
                                <label class="btn btn-outline-primary" for="exportFormatXml">XML</label>
                            </div>
                        `,
                        showCancelButton: true,
                        confirmButtonText: 'Export',
                        cancelButtonText: 'Cancel',
                        confirmButtonColor: '#198754',
                        cancelButtonColor: '#6c757d',
                        preConfirm: () => {
                            const groupSelect = document.getElementById('groupSelectExport');
                            const format = document.querySelector('input[name="exportFormat"]:checked').value;
                            return { groupName: groupSelect.value, format: format };
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            const { groupName, format } = result.value;
                            exportContactsByGroup(groupName, format);
                        }
                    });
                } else {
                    Swal.fire('Error', 'Failed to load groups', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'An error occurred while loading groups', 'error');
            });
        });
        
        // This section is now handled by the updated bulkSendMessageByGroup event handler above
        
        // Bulk assign group functionality removed - now using dedicated groups page
        
        // Add contact form submission handled on dedicated page
        
        // Edit contact form submission handled on dedicated page
        
        // Add Group functionality moved to dedicated page at templates/contacts/groups.html
        
        // Assign group functionality removed - now using dedicated groups page at templates/contacts/groups.html
        
        // Handle search functionality
        document.getElementById('searchButton').addEventListener('click', function() {
            const searchTerm = document.getElementById('contactSearch').value.toLowerCase();
            filterContacts(searchTerm);
        });
        
        document.getElementById('contactSearch').addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                const searchTerm = this.value.toLowerCase();
                filterContacts(searchTerm);
            }
        });
        
        // Functions
        
        function loadGroups() {
            // Hide the loading spinner
            document.getElementById('groupsLoading').style.display = 'none';
            
            // Check if we already have server-side rendered groups
            const existingGroups = document.querySelectorAll('#groupsList .list-group-item');
            if (existingGroups.length > 0) {
                // We already have server-side rendered groups, just update the filter dropdown
                updateGroupFilterDropdown();
                return;
            }
            
            // If no server-side rendered groups, fetch them from the API
            fetch('{{ url_for("contact.api_list_groups") }}')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update groups list with links to the dedicated groups page
                    const groupsList = document.getElementById('groupsList');
                    let groupsHtml = '';
                    
                    data.groups.forEach(group => {
                        // Add to groups list with link to dedicated groups page and action buttons
                        groupsHtml += `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <a href="{{ url_for('contact.groups') }}?group=${group.name}" class="text-decoration-none text-dark flex-grow-1">
                                    ${group.name}
                                    <span class="badge bg-primary rounded-pill ms-2">${group.contact_count}</span>
                                </a>
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-danger" onclick="deleteContactsByGroup('${group.name}')" title="Delete all contacts in this group">
                                        <i data-feather="trash-2"></i>
                                    </button>
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" title="Export all contacts in this group">
                                            <i data-feather="download"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li><a class="dropdown-item" href="#" onclick="exportContactsByGroup('${group.name}', 'csv'); return false;">CSV</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="exportContactsByGroup('${group.name}', 'xml'); return false;">XML</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    });
                    
                    // Only update the groups list if it's empty (no server-side rendered groups)
                    if (!existingGroups.length) {
                        groupsList.innerHTML = groupsHtml;
                    }
                    
                    // Update the filter dropdown
                    updateGroupFilterDropdown();
                } else {
                    console.error('Error loading groups:', data.error);
                    document.getElementById('groupsList').innerHTML = '<div class="alert alert-danger">Error loading groups</div>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('groupsList').innerHTML = '<div class="alert alert-danger">Error loading groups</div>';
                document.getElementById('groupsLoading').style.display = 'none';
            });
        }
        
        function updateGroupFilterDropdown() {
            // Get all group names from the groups list
            const groupItems = document.querySelectorAll('#groupsList .list-group-item');
            const groupFilterMenu = document.getElementById('groupFilterMenu');
            let filterHtml = '<li><a class="dropdown-item active" href="#" data-group="all">All Groups</a></li>';
            
            groupItems.forEach(item => {
                const groupName = item.textContent.trim().split('\n')[0].trim();
                filterHtml += `<li><a class="dropdown-item" href="#" data-group="${groupName}">${groupName}</a></li>`;
            });
            
            groupFilterMenu.innerHTML = filterHtml;
            
            // Add event listeners to group filter items
            document.querySelectorAll('#groupFilterMenu .dropdown-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const group = this.getAttribute('data-group');
                    document.getElementById('groupFilterDropdown').textContent = group === 'all' ? 'All Groups' : group;
                    filterContactsByGroup(group);
                    
                    // Update active state
                    document.querySelectorAll('#groupFilterMenu .dropdown-item').forEach(i => {
                        i.classList.remove('active');
                    });
                    this.classList.add('active');
                });
            });
        }
        
        function openEditContactModal(contactId) {
            // Redirect to the edit contact page instead of opening a modal
            window.location.href = `{{ url_for('contact.edit_contact', contact_id=0) }}`.replace('0', contactId);
        }
        
        function openDeleteConfirmModal(contactId) {
            Swal.fire({
                title: 'Confirm Deletion',
                text: 'Are you sure you want to delete this contact? This action cannot be undone.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Delete',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    deleteContact(contactId);
                }
            });
        }
        
        function openSendMessageModal(contactId, contactName, contactPhone) {
            // Redirect to the messages compose page with the contact information
            window.location.href = `{{ url_for('message.compose') }}?to=${encodeURIComponent(contactPhone)}`;
        }
        
        function deleteContact(contactId) {
            fetch(`{{ url_for('contact.delete_contact', contact_id=0) }}`.replace('0', contactId), {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove the row from the table
                    const row = document.querySelector(`tr[data-contact-id="${contactId}"]`);
                    row.remove();
                    
                    // Show success message
                    Swal.fire({
                        title: 'Deleted!',
                        text: 'Contact has been deleted successfully.',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    // Reload groups to update counts
                    loadGroups();
                } else {
                    Swal.fire({
                        title: 'Error!',
                        text: data.error || 'Failed to delete contact.',
                        icon: 'error'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    title: 'Error!',
                    text: 'An error occurred while deleting the contact.',
                    icon: 'error'
                });
            });
        }
        
        function bulkDeleteContacts(contactIds) {
            fetch('{{ url_for("contact.bulk_delete_contacts") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ contact_ids: contactIds })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove the rows from the table
                    contactIds.forEach(id => {
                        const row = document.querySelector(`tr[data-contact-id="${id}"]`);
                        if (row) row.remove();
                    });
                    
                    // Show success message
                    Swal.fire({
                        title: 'Deleted!',
                        text: `${contactIds.length} contacts have been deleted successfully.`,
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    // Reset select all checkbox
                    document.getElementById('selectAllContacts').checked = false;
                    
                    // Update bulk action buttons
                    updateBulkActionButtons();
                    
                    // Reload groups to update counts
                    loadGroups();
                } else {
                    Swal.fire({
                        title: 'Error!',
                        text: data.error || 'Failed to delete contacts.',
                        icon: 'error'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    title: 'Error!',
                    text: 'An error occurred while deleting the contacts.',
                    icon: 'error'
                });
            });
        }
        
        function getSelectedContactIds() {
            const checkboxes = document.querySelectorAll('.contact-checkbox:checked');
            return Array.from(checkboxes).map(checkbox => checkbox.value);
        }
        
        function updateBulkActionButtons() {
            const selectedCount = document.querySelectorAll('.contact-checkbox:checked').length;
            const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
            const bulkActionDropdown = document.getElementById('bulkActionDropdown');
            
            if (selectedCount > 0) {
                bulkDeleteBtn.disabled = false;
                bulkActionDropdown.disabled = false;
            } else {
                bulkDeleteBtn.disabled = true;
                bulkActionDropdown.disabled = true;
            }
        }
        
        function filterContacts(searchTerm) {
            const rows = document.querySelectorAll('#contactsTable tbody tr');
            
            rows.forEach(row => {
                if (row.cells.length <= 1) return; // Skip the "No contacts found" row
                
                const name = row.cells[1].textContent.toLowerCase();
                const phone = row.cells[2].textContent.toLowerCase();
                const email = row.cells[3].textContent.toLowerCase();
                const group = row.cells[4].textContent.toLowerCase();
                
                if (name.includes(searchTerm) || phone.includes(searchTerm) || 
                    email.includes(searchTerm) || group.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        function filterContactsByGroup(group) {
            const rows = document.querySelectorAll('#contactsTable tbody tr');
            
            if (group === 'all') {
                rows.forEach(row => {
                    row.style.display = '';
                });
                return;
            }
            
            rows.forEach(row => {
                if (row.cells.length <= 1) return; // Skip the "No contacts found" row
                
                const groupCell = row.cells[4].textContent.toLowerCase();
                if (groupCell.includes(group.toLowerCase())) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        function showAlert(type, message) {
            const alertContainer = document.createElement('div');
            alertContainer.className = `alert alert-${type} alert-dismissible fade show`;
            alertContainer.role = 'alert';
            alertContainer.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Find a good place to show the alert
            const container = document.querySelector('.container-fluid');
            container.insertBefore(alertContainer, container.firstChild);
            
            // Auto dismiss after 5 seconds
            setTimeout(() => {
                const bsAlert = new bootstrap.Alert(alertContainer);
                bsAlert.close();
            }, 5000);
        }
        
        function exportSelectedContacts(contactIds, format) {
            // Create a form to submit the selected contact IDs
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `{{ url_for('contact.export_selected_contacts') }}`;
            form.style.display = 'none';
            
            // Add contact IDs as hidden inputs
            const contactIdsInput = document.createElement('input');
            contactIdsInput.type = 'hidden';
            contactIdsInput.name = 'contact_ids';
            contactIdsInput.value = JSON.stringify(contactIds);
            form.appendChild(contactIdsInput);
            
            // Add format as hidden input
            const formatInput = document.createElement('input');
            formatInput.type = 'hidden';
            formatInput.name = 'format';
            formatInput.value = format;
            form.appendChild(formatInput);
            
            // Add CSRF token if needed
            const csrfToken = document.querySelector('meta[name="csrf-token"]');
            if (csrfToken) {
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrf_token';
                csrfInput.value = csrfToken.getAttribute('content');
                form.appendChild(csrfInput);
            }
            
            // Submit the form
            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
        }
        
        function assignContactsToGroup(contactIds, groupName) {
            fetch('{{ url_for("contact.api_add_contacts_to_group") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    group_name: groupName,
                    contact_ids: contactIds
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the UI to reflect the changes
                    contactIds.forEach(id => {
                        const row = document.querySelector(`tr[data-contact-id="${id}"]`);
                        if (row) {
                            const groupCell = row.cells[4];
                            groupCell.innerHTML = `<span class="badge bg-primary">${groupName}</span>`;
                        }
                    });
                    
                    // Show success message
                    Swal.fire({
                        title: 'Success!',
                        text: `${contactIds.length} contacts have been assigned to group "${groupName}".`,
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    // Reload groups to update counts
                    loadGroups();
                } else {
                    Swal.fire({
                        title: 'Error!',
                        text: data.error || 'Failed to assign contacts to group.',
                        icon: 'error'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    title: 'Error!',
                    text: 'An error occurred while assigning contacts to group.',
                    icon: 'error'
                });
            });
        }
        
        function deleteContactsByGroup(groupName) {
            // Confirm deletion
            Swal.fire({
                title: 'Delete Group Contacts',
                text: `Are you sure you want to delete ALL contacts in the "${groupName}" group? This action cannot be undone.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Delete All',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Fetch contacts in the group
                    fetch(`{{ url_for('contact.api_list_contacts') }}?group=${encodeURIComponent(groupName)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.contacts.length > 0) {
                            const contactIds = data.contacts.map(contact => contact.id);
                            // Delete the contacts
                            bulkDeleteContacts(contactIds);
                        } else {
                            Swal.fire('Info', 'No contacts found in this group.', 'info');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire('Error', 'An error occurred while fetching contacts.', 'error');
                    });
                }
            });
        }
        
        function exportContactsByGroup(groupName, format) {
            // Fetch contacts in the group
            fetch(`{{ url_for('contact.api_list_contacts') }}?group=${encodeURIComponent(groupName)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.contacts.length > 0) {
                    const contactIds = data.contacts.map(contact => contact.id);
                    // Export the contacts
                    exportSelectedContacts(contactIds, format);
                } else {
                    Swal.fire('Info', 'No contacts found in this group to export.', 'info');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'An error occurred while fetching contacts for export.', 'error');
            });
        }
    });
    // Function to send message to selected contacts
    function sendMessageToSelectedContacts(contactIds) {
        // Redirect to compose page with selected contact numbers
        fetch('{{ url_for("contact.api_get_contacts_by_ids") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ contact_ids: contactIds })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const phoneNumbers = data.contacts.map(contact => contact.phone).join(',');
                window.location.href = `{{ url_for('message.compose') }}?to=${encodeURIComponent(phoneNumbers)}`;
            } else {
                Swal.fire({
                    title: 'Error!',
                    text: data.error || 'Failed to fetch contact information.',
                    icon: 'error'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                title: 'Error!',
                text: 'An error occurred while fetching contact information.',
                icon: 'error'
            });
        });
    }

    // Function to send message to contacts in a group
    function sendMessageToGroup(groupName) {
        // Fetch contacts in the group
        fetch(`{{ url_for('contact.api_list_contacts') }}?group=${encodeURIComponent(groupName)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.contacts.length > 0) {
                const phoneNumbers = data.contacts.map(contact => contact.phone).join(',');
                window.location.href = `{{ url_for('message.compose') }}?to=${encodeURIComponent(phoneNumbers)}`;
            } else {
                Swal.fire('Info', 'No contacts found in this group to message.', 'info');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire('Error', 'An error occurred while fetching contacts for messaging.', 'error');
        });
    }

    // Function to load message templates
    function loadMessageTemplates(selectElement) {
        fetch('{{ url_for("message.api_list_templates") }}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Clear existing options except the first one
                while (selectElement.options.length > 1) {
                    selectElement.remove(1);
                }
                
                // Add templates to select
                if (data.templates.length > 0) {
                    data.templates.forEach(template => {
                        const option = document.createElement('option');
                        option.value = template.id;
                        option.textContent = template.name;
                        selectElement.appendChild(option);
                    });
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
</script>
{% endblock %}