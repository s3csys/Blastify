{% extends "dashboard.html" %}

{% block content %}
<div class="container-fluid p-0">
    <div class="row mb-2 mb-xl-3">
        <div class="col-auto d-none d-sm-block">
            <h1 class="h3 mb-3"><strong>Contacts</strong> Management</h1>
        </div>

        <div class="col-auto ms-auto text-end mt-n1">
            <a href="{{ url_for('contact.add_page') }}" class="btn btn-primary">
                <i class="align-middle" data-feather="user-plus"></i> Add Contact
            </a>
            <a href="{{ url_for('contact.import_page') }}" class="btn btn-light">
                <i class="align-middle" data-feather="upload"></i> Import
            </a>
            <div class="dropdown d-inline-block">
                <button class="btn btn-light dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="align-middle" data-feather="download"></i> Export
                </button>
                <ul class="dropdown-menu" aria-labelledby="exportDropdown">
                    <li><a class="dropdown-item" href="{{ url_for('contact.export_contacts', format='csv') }}">CSV</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('contact.export_contacts', format='xml') }}">XML</a></li>
                </ul>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12 col-lg-8 col-xxl-9 d-flex">
            <div class="card flex-fill">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Contact List</h5>
                        <div class="d-flex">
                            <div class="input-group me-2">
                                <input type="text" class="form-control" id="contactSearch" placeholder="Search contacts...">
                                <button class="btn btn-outline-secondary" type="button" id="searchButton">
                                    <i class="align-middle" data-feather="search"></i>
                                </button>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="groupFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    All Groups
                                </button>
                                <ul class="dropdown-menu" id="groupFilterMenu" aria-labelledby="groupFilterDropdown">
                                    <li><a class="dropdown-item active" href="#" data-group="all">All Groups</a></li>
                                    <!-- Groups will be loaded dynamically -->
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover my-0" id="contactsTable">
                            <thead>
                                <tr>
                                    <th>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="selectAllContacts">
                                            <label class="form-check-label" for="selectAllContacts"></label>
                                        </div>
                                    </th>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th>Group</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for contact in contacts.items %}
                                <tr data-contact-id="{{ contact.id }}">
                                    <td>
                                        <div class="form-check">
                                            <input class="form-check-input contact-checkbox" type="checkbox" value="{{ contact.id }}">
                                            <label class="form-check-label"></label>
                                        </div>
                                    </td>
                                    <td>{{ contact.name }}</td>
                                    <td>{{ contact.phone }}</td>
                                    <td>{{ contact.email or '-' }}</td>
                                    <td><span class="badge bg-primary">{{ contact.group or 'default' }}</span></td>
                                    <td>
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-outline-primary edit-contact" data-contact-id="{{ contact.id }}">
                                                <i data-feather="edit-2"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger delete-contact" data-contact-id="{{ contact.id }}">
                                                <i data-feather="trash"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-success send-message" data-contact-id="{{ contact.id }}" data-contact-name="{{ contact.name }}" data-contact-phone="{{ contact.phone }}">
                                                <i data-feather="message-square"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="6" class="text-center">No contacts found</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer d-flex justify-content-between align-items-center">
                    <div>
                        <button id="bulkDeleteBtn" class="btn btn-sm btn-danger" disabled>
                            <i class="align-middle" data-feather="trash-2"></i> Delete Selected
                        </button>
                        <div class="dropdown d-inline-block">
                            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="bulkActionDropdown" data-bs-toggle="dropdown" aria-expanded="false" disabled>
                                Bulk Actions
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="bulkActionDropdown">
                                <li><a class="dropdown-item" href="#" id="bulkExport">Export Selected</a></li>
                            </ul>
                        </div>
                    </div>
                    <nav>
                        <ul class="pagination mb-0">
                            {% if contacts.has_prev %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('contact.index', page=contacts.prev_num) }}">&laquo;</a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <a class="page-link" href="#">&laquo;</a>
                            </li>
                            {% endif %}
                            
                            {% for page_num in contacts.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                                {% if page_num %}
                                    {% if contacts.page == page_num %}
                                    <li class="page-item active">
                                        <a class="page-link" href="{{ url_for('contact.index', page=page_num) }}">{{ page_num }}</a>
                                    </li>
                                    {% else %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('contact.index', page=page_num) }}">{{ page_num }}</a>
                                    </li>
                                    {% endif %}
                                {% else %}
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#">...</a>
                                    </li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if contacts.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('contact.index', page=contacts.next_num) }}">&raquo;</a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <a class="page-link" href="#">&raquo;</a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-4 col-xxl-3 d-flex">
            <div class="card flex-fill">
                <div class="card-header">
                    <h5 class="card-title mb-0">Contact Groups</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-3">
                        <i class="align-middle" data-feather="info"></i>
                        <p><strong>Important:</strong> Group management has been moved to the dedicated Groups page.</p>
                        <p>To add, edit, or delete groups, please use the <a href="{{ url_for('contact.groups') }}">Groups page</a>.</p>
                        <p>Do not attempt to add groups from this page.</p>
                    </div>
                    <div class="d-grid gap-2 mb-3">
                        <a href="{{ url_for('contact.groups') }}" class="btn btn-primary">
                            <i class="align-middle" data-feather="users"></i> Manage Groups
                        </a>
                    </div>
                    <div class="list-group" id="groupsList">
                        <!-- Groups will be loaded dynamically -->
                        <div class="text-center py-3" id="groupsLoading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Contact Modal removed - now using dedicated page -->

<!-- Edit Contact Modal removed - now using dedicated page -->

<!-- Add Group Modal removed - now using dedicated page at templates/contacts/groups.html -->
    </div>
</div>

<!-- Assign to Group Modal removed - now using dedicated page at templates/contacts/groups.html -->

<!-- SweetAlert2 script -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Feather icons
        feather.replace();
        
        // Load contact groups
        loadGroups();
        
        // Handle select all checkbox
        document.getElementById('selectAllContacts').addEventListener('change', function() {
            const isChecked = this.checked;
            document.querySelectorAll('.contact-checkbox').forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            updateBulkActionButtons();
        });
        
        // Handle individual contact checkboxes
        document.querySelectorAll('.contact-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', updateBulkActionButtons);
        });
        
        // Handle edit contact button clicks
        document.querySelectorAll('.edit-contact').forEach(button => {
            button.addEventListener('click', function() {
                const contactId = this.getAttribute('data-contact-id');
                openEditContactModal(contactId);
            });
        });
        
        // Handle delete contact button clicks
        document.querySelectorAll('.delete-contact').forEach(button => {
            button.addEventListener('click', function() {
                const contactId = this.getAttribute('data-contact-id');
                openDeleteConfirmModal(contactId);
            });
        });
        
        // Handle send message button clicks
        document.querySelectorAll('.send-message').forEach(button => {
            button.addEventListener('click', function() {
                const contactId = this.getAttribute('data-contact-id');
                const contactName = this.getAttribute('data-contact-name');
                const contactPhone = this.getAttribute('data-contact-phone');
                openSendMessageModal(contactId, contactName, contactPhone);
            });
        });
        
        // Handle bulk delete button
        document.getElementById('bulkDeleteBtn').addEventListener('click', function() {
            const selectedContacts = getSelectedContactIds();
            if (selectedContacts.length > 0) {
                Swal.fire({
                    title: 'Confirm Bulk Deletion',
                    text: `Are you sure you want to delete ${selectedContacts.length} contacts? This action cannot be undone.`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Delete All',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        bulkDeleteContacts(selectedContacts);
                    }
                });
            }
        });
        
        // Bulk assign group functionality removed - now using dedicated groups page
        
        // Add contact form submission handled on dedicated page
        
        // Edit contact form submission handled on dedicated page
        
        // Add Group functionality moved to dedicated page at templates/contacts/groups.html
        
        // Assign group functionality removed - now using dedicated groups page at templates/contacts/groups.html
        
        // Handle search functionality
        document.getElementById('searchButton').addEventListener('click', function() {
            const searchTerm = document.getElementById('contactSearch').value.toLowerCase();
            filterContacts(searchTerm);
        });
        
        document.getElementById('contactSearch').addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                const searchTerm = this.value.toLowerCase();
                filterContacts(searchTerm);
            }
        });
        
        // Functions
        
        function loadGroups() {
            fetch('{{ url_for("contact.api_list_groups") }}')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update group filter dropdown
                    const groupFilterMenu = document.getElementById('groupFilterMenu');
                    let filterHtml = '<li><a class="dropdown-item active" href="#" data-group="all">All Groups</a></li>';
                    
                    // Update groups list with links to the dedicated groups page
                    // Note: Group management has been moved to the dedicated groups.html page
                    const groupsList = document.getElementById('groupsList');
                    let groupsHtml = '';
                    
                    // Update assign group select in modal - removed
                    
                    data.groups.forEach(group => {
                        // Add to filter dropdown
                        filterHtml += `<li><a class="dropdown-item" href="#" data-group="${group.name}">${group.name}</a></li>`;
                        
                        // Add to groups list with link to dedicated groups page
                        groupsHtml += `
                        <a href="{{ url_for('contact.groups') }}?group=${group.name}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            ${group.name}
                            <span class="badge bg-primary rounded-pill">${group.contact_count}</span>
                        </a>`;
                    });
                    
                    groupFilterMenu.innerHTML = filterHtml;
                    groupsList.innerHTML = groupsHtml;
                    document.getElementById('groupsLoading').style.display = 'none';
                    
                    // Assign group select removed - now using dedicated groups page
                    
                    // Add event listeners to group filter items
                    document.querySelectorAll('#groupFilterMenu .dropdown-item').forEach(item => {
                        item.addEventListener('click', function(e) {
                            e.preventDefault();
                            const group = this.getAttribute('data-group');
                            document.getElementById('groupFilterDropdown').textContent = group === 'all' ? 'All Groups' : group;
                            filterContactsByGroup(group);
                            
                            // Update active state
                            document.querySelectorAll('#groupFilterMenu .dropdown-item').forEach(i => {
                                i.classList.remove('active');
                            });
                            this.classList.add('active');
                        });
                    });
                } else {
                    console.error('Error loading groups:', data.error);
                    document.getElementById('groupsList').innerHTML = '<div class="alert alert-danger">Error loading groups</div>';
                    document.getElementById('groupsLoading').style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('groupsList').innerHTML = '<div class="alert alert-danger">Error loading groups</div>';
                document.getElementById('groupsLoading').style.display = 'none';
            });
        }
        
        function openEditContactModal(contactId) {
            // Redirect to the edit contact page instead of opening a modal
            window.location.href = `{{ url_for('contact.edit_contact', contact_id=0) }}`.replace('0', contactId);
        }
        
        function openDeleteConfirmModal(contactId) {
            Swal.fire({
                title: 'Confirm Deletion',
                text: 'Are you sure you want to delete this contact? This action cannot be undone.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Delete',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    deleteContact(contactId);
                }
            });
        }
        
        function openSendMessageModal(contactId, contactName, contactPhone) {
            // Redirect to the messages compose page with the contact information
            window.location.href = `{{ url_for('message.compose') }}?to=${encodeURIComponent(contactPhone)}`;
        }
        
        function deleteContact(contactId) {
            fetch(`{{ url_for('contact.delete_contact', contact_id=0) }}`.replace('0', contactId), {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove the row from the table
                    const row = document.querySelector(`tr[data-contact-id="${contactId}"]`);
                    row.remove();
                    
                    // Show success message
                    Swal.fire({
                        title: 'Deleted!',
                        text: 'Contact has been deleted successfully.',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    // Reload groups to update counts
                    loadGroups();
                } else {
                    Swal.fire({
                        title: 'Error!',
                        text: data.error || 'Failed to delete contact.',
                        icon: 'error'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    title: 'Error!',
                    text: 'An error occurred while deleting the contact.',
                    icon: 'error'
                });
            });
        }
        
        function bulkDeleteContacts(contactIds) {
            fetch('{{ url_for("contact.bulk_delete_contacts") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ contact_ids: contactIds })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove the rows from the table
                    contactIds.forEach(id => {
                        const row = document.querySelector(`tr[data-contact-id="${id}"]`);
                        if (row) row.remove();
                    });
                    
                    // Show success message
                    Swal.fire({
                        title: 'Deleted!',
                        text: `${contactIds.length} contacts have been deleted successfully.`,
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    // Reset select all checkbox
                    document.getElementById('selectAllContacts').checked = false;
                    
                    // Update bulk action buttons
                    updateBulkActionButtons();
                    
                    // Reload groups to update counts
                    loadGroups();
                } else {
                    Swal.fire({
                        title: 'Error!',
                        text: data.error || 'Failed to delete contacts.',
                        icon: 'error'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    title: 'Error!',
                    text: 'An error occurred while deleting the contacts.',
                    icon: 'error'
                });
            });
        }
        
        function getSelectedContactIds() {
            const checkboxes = document.querySelectorAll('.contact-checkbox:checked');
            return Array.from(checkboxes).map(checkbox => checkbox.value);
        }
        
        function updateBulkActionButtons() {
            const selectedCount = document.querySelectorAll('.contact-checkbox:checked').length;
            const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
            const bulkActionDropdown = document.getElementById('bulkActionDropdown');
            
            if (selectedCount > 0) {
                bulkDeleteBtn.disabled = false;
                bulkActionDropdown.disabled = false;
            } else {
                bulkDeleteBtn.disabled = true;
                bulkActionDropdown.disabled = true;
            }
        }
        
        function filterContacts(searchTerm) {
            const rows = document.querySelectorAll('#contactsTable tbody tr');
            
            rows.forEach(row => {
                if (row.cells.length <= 1) return; // Skip the "No contacts found" row
                
                const name = row.cells[1].textContent.toLowerCase();
                const phone = row.cells[2].textContent.toLowerCase();
                const email = row.cells[3].textContent.toLowerCase();
                const group = row.cells[4].textContent.toLowerCase();
                
                if (name.includes(searchTerm) || phone.includes(searchTerm) || 
                    email.includes(searchTerm) || group.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        function filterContactsByGroup(group) {
            const rows = document.querySelectorAll('#contactsTable tbody tr');
            
            if (group === 'all') {
                rows.forEach(row => {
                    row.style.display = '';
                });
                return;
            }
            
            rows.forEach(row => {
                if (row.cells.length <= 1) return; // Skip the "No contacts found" row
                
                const groupCell = row.cells[4].textContent.toLowerCase();
                if (groupCell.includes(group.toLowerCase())) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        function showAlert(type, message) {
            const alertContainer = document.createElement('div');
            alertContainer.className = `alert alert-${type} alert-dismissible fade show`;
            alertContainer.role = 'alert';
            alertContainer.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Find a good place to show the alert
            const container = document.querySelector('.container-fluid');
            container.insertBefore(alertContainer, container.firstChild);
            
            // Auto dismiss after 5 seconds
            setTimeout(() => {
                const bsAlert = new bootstrap.Alert(alertContainer);
                bsAlert.close();
            }, 5000);
        }
    });
</script>
{% endblock %}