{% extends "dashboard.html" %}

{% block content %}
<div class="container-fluid p-0">
    <div class="row mb-2 mb-xl-3">
        <div class="col-auto d-none d-sm-block">
            <h1 class="h3 mb-3"><strong>Compose</strong> Message</h1>
        </div>

        <div class="col-auto ms-auto text-end mt-n1">
            <a href="{{ url_for('message.index') }}" class="btn btn-secondary">
                <i class="align-middle" data-feather="arrow-left"></i> Back to Messages
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card theme-card">
                <div class="card-header">
                    <h5 class="card-title">New Message</h5>
                </div>
                <div class="card-body">
                    <!-- Alert Container for displaying messages -->
                    <div id="alertContainer"></div>
                    
                    <form id="composeForm" action="{{ url_for('message.send_message') }}" method="POST" enctype="multipart/form-data">
                        <input type="hidden" name="platform" value="whatsapp">
                        <div class="mb-3">
                            <label class="form-label">Recipients</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <select class="form-select" id="recipientType" name="recipient_type">
                                        <option value="individual">Individual Contacts</option>
                                        <option value="multiple">Multiple Contacts</option>
                                        <option value="group">Contact Group</option>
                                        <option value="custom">Custom Numbers</option>
                                    </select>
                                </div>
                                <div class="col-md-6" id="individualContactsContainer">
                                    <select class="form-select" id="individualContacts" name="individual_contacts">
                                        <option value="" selected disabled>Select a contact</option>
                                        {% for contact in contacts %}
                                        <option value="{{ contact.id }}">{{ contact.name }} ({{ contact.phone }})</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6" id="multipleContactsContainer" style="display: none;">
                                    <select class="form-select" id="multipleContacts" name="multiple_contacts[]" multiple data-placeholder="Select multiple contacts">
                                        {% for contact in contacts %}
                                        <option value="{{ contact.id }}">{{ contact.name }} ({{ contact.phone }})</option>
                                        {% endfor %}
                                    </select>
                                    <small class="form-text text-muted mt-1">Click on contacts to select/deselect them using the checkboxes</small>
                                </div>
                                <div class="col-md-6" id="contactGroupContainer" style="display: none;">
                                    <select class="form-select" id="contactGroup" name="contact_group">
                                        <option value="" selected disabled>Select a group</option>
                                        {% for group in groups %}
                                        <option value="{{ group.id }}">{{ group.name }} ({{ group.contact_count }} contacts)</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6" id="customNumbersContainer" style="display: none;">
                                    <textarea class="form-control" id="customNumbers" name="custom_numbers" rows="3" placeholder="Enter phone numbers separated by commas or new lines"></textarea>
                                    <small class="form-text text-muted">Format: +1234567890, +0987654321</small>
                                    <div class="mt-2">
                                        <button type="button" class="btn btn-sm btn-outline-secondary" id="validateNumbersBtn">Validate Numbers</button>
                                        <div id="validationResults" class="mt-2" style="display: none;">
                                            <div class="alert alert-info">
                                                <span id="validNumbersCount">0</span> valid numbers found.
                                                <div id="invalidNumbersContainer" style="display: none;">
                                                    <hr>
                                                    <p class="mb-0">Invalid numbers:</p>
                                                    <ul id="invalidNumbersList" class="mb-0"></ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Message Template</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <select class="form-select" id="messageTemplate" name="template_id">
                                        <option value="">Select a template or create a new message</option>
                                        {% for template in templates %}
                                        <option value="{{ template.id }}">{{ template.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex">
                                        <button type="button" class="btn btn-outline-primary me-2" id="previewTemplateBtn">
                                            <i class="align-middle" data-feather="eye"></i> Preview Template
                                        </button>
                                        <a href="{{ url_for('message.templates_create') }}" class="btn btn-outline-secondary">
                                            <i class="align-middle" data-feather="plus"></i> Create Template
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Message</label>
                            <textarea class="form-control" id="messageContent" name="content" rows="5" placeholder="Type your message here..."></textarea>
                            <small class="form-text text-muted">
                                Available variables: {name}, {phone}, {group}, {date}
                            </small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Media (Optional)</label>
                            <div class="input-group">
                                <input type="file" class="form-control" id="messageMedia" name="media" accept="image/jpeg,image/png,application/pdf">
                                <button class="btn btn-outline-secondary" type="button" id="clearMediaBtn">
                                    <i class="align-middle" data-feather="x"></i>
                                </button>
                            </div>
                            <small class="form-text text-muted">
                                Supported formats: JPG, PNG, PDF (max 5MB)
                            </small>
                            <div id="mediaPreviewContainer" style="display: none;">
                                <div id="mediaPreview" class="mt-2"></div>
                                <button type="button" class="btn btn-sm btn-outline-danger mt-2" id="removeMediaBtn">
                                    <i class="align-middle" data-feather="trash-2"></i> Remove Media
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="scheduleMessage" name="schedule_message">
                                <label class="form-check-label" for="scheduleMessage">
                                    Schedule this message for later
                                </label>
                            </div>
                        </div>
                        <div class="mb-3" id="scheduleTimeContainer" style="display: none;">
                            <label class="form-label">Schedule Time</label>
                            <div class="input-group date" id="scheduleTimePicker" data-target-input="nearest">
                                <input type="text" class="form-control datetimepicker-input" id="scheduleTime" name="schedule_time" data-target="#scheduleTimePicker" placeholder="Select date and time">
                                <div class="input-group-append" data-target="#scheduleTimePicker" data-toggle="datetimepicker">
                                    <div class="input-group-text"><i class="far fa-calendar"></i></div>
                                </div>
                            </div>
                            <small class="form-text text-muted">Schedule your message to be sent at a specific time</small>
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-secondary" id="saveAsDraftBtn">
                                <i class="align-middle" data-feather="save"></i> Save as Draft
                            </button>
                            <button type="submit" class="btn btn-primary" id="sendMessageBtn">
                                <i class="align-middle" data-feather="send"></i> Send Message
                            </button>
                        </div>
                        <input type="hidden" id="isDraft" name="is_draft" value="0">
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Template Preview Modal -->
    <div class="modal fade theme-modal" id="templatePreviewModal" tabindex="-1" aria-labelledby="templatePreviewModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="templatePreviewModalLabel">Template Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="templatePreviewContent">
                        <!-- Template preview will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="useTemplateBtn">Use This Template</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    /* Custom styles for Select2 dropdowns */
    .select2-result-contact {
        display: flex;
        align-items: center;
        padding: 8px 12px;
    }
    
    .select2-result-contact .form-check {
        width: 100%;
        margin: 0;
        padding: 0;
    }
    
    .select2-result-contact .form-check-input {
        margin-right: 8px;
    }
    
    .select2-result-contact .form-check-label {
        cursor: pointer;
        width: 100%;
        margin: 0;
    }
    
    /* Group styling */
    .select2-result-group {
        display: flex;
        align-items: center;
        padding: 8px 12px;
    }
    
    /* Ensure the select2 dropdown is wide enough */
    .select2-container--default .select2-results > .select2-results__options {
        max-height: 300px;
        overflow-y: auto;
    }
    
    /* Style for selected items in multiple select */
    .select2-container--default .select2-selection--multiple .select2-selection__choice {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 4px 8px;
        margin-right: 5px;
        margin-top: 5px;
    }
    
    /* Hover effect for dropdown items */
    .select2-results__option--highlighted[aria-selected] {
        background-color: rgba(0, 123, 255, 0.1) !important;
        color: inherit !important;
    }
    
    /* Custom styling for different dropdown types */
    .select2-dropdown-multiple .select2-results__option {
        padding: 0 !important;
    }
    
    .select2-dropdown-multiple .select2-results__option[aria-selected=true] {
        background-color: transparent !important;
    }
    
    .select2-dropdown-group .select2-results__option,
    .select2-dropdown-individual .select2-results__option {
        padding: 0 !important;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Template URLs for AJAX calls
    const templateUrls = {
        get: "{{ url_for('message.templates_get') }}",
        getContactData: "{{ url_for('message.templates_get_contact_data') }}",
        preview: "{{ url_for('message.templates_preview') }}"
    };
</script>
<script src="{{ url_for('static', filename='js/modules/templates/compose.js') }}"></script>
{% endblock %}