{% extends "dashboard.html" %}

{% block content %}
<div class="container-fluid p-0" id="contacts-index-container">
    <div class="row mb-2 mb-xl-3">
        <div class="col-auto d-none d-sm-block">
            <h1 class="h3 mb-3"><strong>Contacts</strong> Management</h1>
        </div>

        <div class="col-auto ms-auto text-end mt-n1">
            <div class="dropdown d-inline-block me-2">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="importExportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="align-middle" data-feather="upload"></i> Import/Export
                </button>
                <ul class="dropdown-menu" aria-labelledby="importExportDropdown">
                    <li><a class="dropdown-item" href="{{ url_for('contact.import_page') }}"><i class="align-middle" data-feather="upload"></i> Import Contacts</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('contact.export_page') }}"><i class="align-middle" data-feather="download"></i> Export Contacts</a></li>
                </ul>
            </div>
            <a href="{{ url_for('contact.groups') }}" class="btn btn-secondary me-2">
                <i class="align-middle" data-feather="users"></i> Groups
            </a>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addContactModal">
                <i class="align-middle" data-feather="user-plus"></i> Add Contact
            </button>
        </div>
    </div>

    <div class="row">
        <div class="col-12 d-flex">
            <div class="card flex-fill theme-card">
                <div class="card-header">
                    <div class="row align-items-center">
                        <div class="col-md-6 mb-2 mb-md-0">
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Search contacts..." id="searchContacts">
                                <button class="btn btn-outline-secondary" type="button" id="searchContactsBtn">
                                    <i class="align-middle" data-feather="search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex justify-content-md-end">
                                <div class="me-2">
                                    <select class="form-select" id="filterGroup">
                                        <option value="all">All Groups</option>
                                        <!-- Groups will be loaded dynamically -->
                                    </select>
                                </div>
                                <div class="dropdown">
                                    <button class="btn btn-secondary dropdown-toggle" type="button" id="bulkActionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        Bulk Actions
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bulkActionsDropdown">
                                        <li><a class="dropdown-item" href="#" id="bulkAssignGroup"><i class="align-middle" data-feather="tag"></i> Assign to Group</a></li>
                                        <li><a class="dropdown-item" href="#" id="bulkRemoveGroup"><i class="align-middle" data-feather="tag-off"></i> Remove from Group</a></li>
                                        <li><a class="dropdown-item" href="#" id="bulkSendMessage"><i class="align-middle" data-feather="message-square"></i> Send Message</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#" id="bulkDelete"><i class="align-middle" data-feather="trash-2"></i> Delete</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover my-0" id="contactsTable">
                            <thead>
                                <tr>
                                    <th>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="selectAllContacts">
                                            <label class="form-check-label" for="selectAllContacts"></label>
                                        </div>
                                    </th>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th>Group</th>
                                    <th>Added On</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Contacts will be loaded dynamically -->
                                <tr id="loadingRow">
                                    <td colspan="7" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer d-flex justify-content-between align-items-center">
                    <div>
                        <span id="contactCount">0</span> contacts
                    </div>
                    <nav>
                        <ul class="pagination mb-0" id="contactsPagination">
                            <!-- Pagination will be generated dynamically -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Contact Modal -->
<div class="modal fade theme-modal" id="addContactModal" tabindex="-1" aria-labelledby="addContactModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addContactModalLabel">Add New Contact</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="contactForm">
                    <input type="hidden" id="contactId" name="id">
                    <div class="mb-3">
                        <label for="contactName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="contactName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="contactPhone" class="form-label">Phone Number</label>
                        <div class="input-group">
                            <span class="input-group-text">+</span>
                            <input type="tel" class="form-control" id="contactPhone" name="phone" required placeholder="Country code and number">
                        </div>
                        <div class="form-text">Include country code without the + sign (e.g., 1234567890)</div>
                    </div>
                    <div class="mb-3">
                        <label for="contactEmail" class="form-label">Email (Optional)</label>
                        <input type="email" class="form-control" id="contactEmail" name="email">
                    </div>
                    <div class="mb-3">
                        <label for="contactGroup" class="form-label">Group</label>
                        <select class="form-select" id="contactGroup" name="group">
                            <option value="default">Default</option>
                            <!-- Groups will be loaded dynamically -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="contactNotes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="contactNotes" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveContactBtn">Save Contact</button>
            </div>
        </div>
    </div>
</div>

<!-- Assign Group Modal -->
<div class="modal fade theme-modal" id="assignGroupModal" tabindex="-1" aria-labelledby="assignGroupModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assignGroupModalLabel">Assign to Group</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Select a group to assign the selected contacts:</p>
                <form id="assignGroupForm">
                    <div class="mb-3">
                        <select class="form-select" id="assignGroupSelect" name="group" required>
                            <option value="" selected disabled>Select a group</option>
                            <!-- Groups will be loaded dynamically -->
                        </select>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="keepExistingGroups" name="keep_existing" checked>
                        <label class="form-check-label" for="keepExistingGroups">
                            Keep existing group assignments
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmAssignGroupBtn">Assign</button>
            </div>
        </div>
    </div>
</div>

<!-- Remove Group Modal -->
<div class="modal fade theme-modal" id="removeGroupModal" tabindex="-1" aria-labelledby="removeGroupModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="removeGroupModalLabel">Remove from Group</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Select a group to remove the selected contacts from:</p>
                <form id="removeGroupForm">
                    <div class="mb-3">
                        <select class="form-select" id="removeGroupSelect" name="group" required>
                            <option value="" selected disabled>Select a group</option>
                            <!-- Groups will be loaded dynamically -->
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmRemoveGroupBtn">Remove</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade theme-modal" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="deleteConfirmMessage">Are you sure you want to delete this contact?</p>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="confirmDelete">
                    <label class="form-check-label" for="confirmDelete">
                        I understand that this action cannot be undone.
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" disabled>Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Send Message Modal -->
<div class="modal fade theme-modal" id="sendMessageModal" tabindex="-1" aria-labelledby="sendMessageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sendMessageModalLabel">Send Message</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="sendMessageInfo">You are about to send a message to <span id="messageRecipientCount">0</span> contacts.</p>
                <form id="sendMessageForm">
                    <div class="mb-3">
                        <label for="messageTemplate" class="form-label">Message Template</label>
                        <select class="form-select" id="messageTemplate" name="template_id">
                            <option value="">Select a template or type a custom message</option>
                            <!-- Templates will be loaded dynamically -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="messageContent" class="form-label">Message Content</label>
                        <textarea class="form-control" id="messageContent" name="content" rows="5" required></textarea>
                        <div class="form-text">
                            You can use the following variables in your message:
                            <code>{name}</code>, <code>{phone}</code>, <code>{email}</code>, <code>{group}</code>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="scheduleSend" class="form-label">Schedule Send</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="enableSchedule">
                            <label class="form-check-label" for="enableSchedule">Schedule this message</label>
                        </div>
                    </div>
                    <div class="mb-3" id="scheduleTimeContainer" style="display: none;">
                        <label for="scheduleTime" class="form-label">Send Time</label>
                        <input type="datetime-local" class="form-control" id="scheduleTime" name="schedule_time">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="sendMessageBtn">Send Message</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Feather icons
        feather.replace();
        
        // Apply theme-specific adjustments
        applyThemeAdjustments();
        
        // Load contacts and groups
        loadContacts();
        loadGroups();
        
        // Select all contacts checkbox handler
        document.getElementById('selectAllContacts').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('#contactsTable tbody input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            
            updateBulkActionState();
        });
        
        // Contacts table checkbox change handler
        document.getElementById('contactsTable').addEventListener('change', function(e) {
            if (e.target.type === 'checkbox') {
                updateBulkActionState();
            }
        });
        
        // Search contacts handler
        document.getElementById('searchContactsBtn').addEventListener('click', function() {
            const searchTerm = document.getElementById('searchContacts').value;
            loadContacts(searchTerm);
        });
        
        document.getElementById('searchContacts').addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                const searchTerm = e.target.value;
                loadContacts(searchTerm);
            }
        });
        
        // Filter by group handler
        document.getElementById('filterGroup').addEventListener('change', function() {
            const group = this.value;
            loadContacts(null, group);
        });
        
        // Save contact button handler
        document.getElementById('saveContactBtn').addEventListener('click', function() {
            const form = document.getElementById('contactForm');
            const formData = new FormData(form);
            
            // Validate form
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            // Convert FormData to JSON
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });
            
            // Add + to phone number if not present
            if (data.phone && !data.phone.startsWith('+')) {
                data.phone = '+' + data.phone;
            }
            
            // Determine if this is an add or edit operation
            const isEdit = data.id ? true : false;
            const url = isEdit ? `/contact/edit/${data.id}` : '/contact/add';
            
            // Send request to add/edit contact
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close modal and reload contacts
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addContactModal'));
                    modal.hide();
                    form.reset();
                    loadContacts();
                    
                    // Show success message
                    showAlert('success', isEdit ? 'Contact updated successfully!' : 'Contact added successfully!');
                } else {
                    showAlert('danger', data.error || 'Failed to save contact.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('danger', 'An error occurred while saving the contact.');
            });
        });
        
        // Bulk assign group button handler
        document.getElementById('bulkAssignGroup').addEventListener('click', function() {
            const selectedContacts = getSelectedContacts();
            
            if (selectedContacts.length > 0) {
                // Load groups for the assign group modal
                loadGroupsForModal('assignGroupSelect');
                
                // Show assign group modal
                const modal = new bootstrap.Modal(document.getElementById('assignGroupModal'));
                modal.show();
            } else {
                showAlert('warning', 'Please select at least one contact.');
            }
        });
        
        // Confirm assign group button handler
        document.getElementById('confirmAssignGroupBtn').addEventListener('click', function() {
            const form = document.getElementById('assignGroupForm');
            
            // Validate form
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const group = document.getElementById('assignGroupSelect').value;
            const keepExisting = document.getElementById('keepExistingGroups').checked;
            const selectedContacts = getSelectedContacts();
            
            // Send request to assign group
            fetch('/contact/bulk/assign_group', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contact_ids: selectedContacts,
                    group: group,
                    keep_existing: keepExisting
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close modal and reload contacts
                    const modal = bootstrap.Modal.getInstance(document.getElementById('assignGroupModal'));
                    modal.hide();
                    form.reset();
                    loadContacts();
                    
                    // Show success message
                    showAlert('success', `Assigned ${selectedContacts.length} contacts to group ${group}!`);
                } else {
                    showAlert('danger', data.error || 'Failed to assign group.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('danger', 'An error occurred while assigning group.');
            });
        });
        
        // Bulk remove group button handler
        document.getElementById('bulkRemoveGroup').addEventListener('click', function() {
            const selectedContacts = getSelectedContacts();
            
            if (selectedContacts.length > 0) {
                // Load groups for the remove group modal
                loadGroupsForModal('removeGroupSelect');
                
                // Show remove group modal
                const modal = new bootstrap.Modal(document.getElementById('removeGroupModal'));
                modal.show();
            } else {
                showAlert('warning', 'Please select at least one contact.');
            }
        });
        
        // Confirm remove group button handler
        document.getElementById('confirmRemoveGroupBtn').addEventListener('click', function() {
            const form = document.getElementById('removeGroupForm');
            
            // Validate form
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const group = document.getElementById('removeGroupSelect').value;
            const selectedContacts = getSelectedContacts();
            
            // Send request to remove group
            fetch('/contact/bulk/remove_group', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contact_ids: selectedContacts,
                    group: group
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close modal and reload contacts
                    const modal = bootstrap.Modal.getInstance(document.getElementById('removeGroupModal'));
                    modal.hide();
                    form.reset();
                    loadContacts();
                    
                    // Show success message
                    showAlert('success', `Removed ${selectedContacts.length} contacts from group ${group}!`);
                } else {
                    showAlert('danger', data.error || 'Failed to remove group.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('danger', 'An error occurred while removing group.');
            });
        });
        
        // Bulk delete button handler
        document.getElementById('bulkDelete').addEventListener('click', function() {
            const selectedContacts = getSelectedContacts();
            
            if (selectedContacts.length > 0) {
                // Update delete confirmation message
                document.getElementById('deleteConfirmMessage').textContent = `Are you sure you want to delete ${selectedContacts.length} contacts? This action cannot be undone.`;
                
                // Reset confirmation checkbox
                document.getElementById('confirmDelete').checked = false;
                document.getElementById('confirmDeleteBtn').disabled = true;
                
                // Show delete confirmation modal
                const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
                modal.show();
            } else {
                showAlert('warning', 'Please select at least one contact.');
            }
        });
        
        // Delete confirmation checkbox handler
        document.getElementById('confirmDelete').addEventListener('change', function() {
            document.getElementById('confirmDeleteBtn').disabled = !this.checked;
        });
        
        // Confirm delete button handler
        document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
            const selectedContacts = getSelectedContacts();
            
            // Send request to delete contacts
            fetch('/contact/bulk/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contact_ids: selectedContacts
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close modal and reload contacts
                    const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
                    modal.hide();
                    loadContacts();
                    
                    // Show success message
                    showAlert('success', `Deleted ${selectedContacts.length} contacts successfully!`);
                } else {
                    showAlert('danger', data.error || 'Failed to delete contacts.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('danger', 'An error occurred while deleting contacts.');
            });
        });
        
        // Bulk send message button handler
        document.getElementById('bulkSendMessage').addEventListener('click', function() {
            const selectedContacts = getSelectedContacts();
            
            if (selectedContacts.length > 0) {
                // Update message recipient count
                document.getElementById('messageRecipientCount').textContent = selectedContacts.length;
                
                // Load message templates
                loadMessageTemplates();
                
                // Reset schedule options
                document.getElementById('enableSchedule').checked = false;
                document.getElementById('scheduleTimeContainer').style.display = 'none';
                
                // Show send message modal
                const modal = new bootstrap.Modal(document.getElementById('sendMessageModal'));
                modal.show();
            } else {
                showAlert('warning', 'Please select at least one contact.');
            }
        });
        
        // Message template change handler
        document.getElementById('messageTemplate').addEventListener('change', function() {
            const templateId = this.value;
            
            if (templateId) {
                // Load template content
                fetch(`/message/templates/${templateId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('messageContent').value = data.template.content;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            }
        });
        
        // Schedule switch handler
        document.getElementById('enableSchedule').addEventListener('change', function() {
            const scheduleTimeContainer = document.getElementById('scheduleTimeContainer');
            scheduleTimeContainer.style.display = this.checked ? 'block' : 'none';
            
            if (this.checked) {
                // Set default schedule time to 1 hour from now
                const now = new Date();
                now.setHours(now.getHours() + 1);
                const dateTimeString = now.toISOString().slice(0, 16);
                document.getElementById('scheduleTime').value = dateTimeString;
            }
        });
        
        // Send message button handler
        document.getElementById('sendMessageBtn').addEventListener('click', function() {
            const form = document.getElementById('sendMessageForm');
            const selectedContacts = getSelectedContacts();
            
            // Validate form
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const formData = new FormData(form);
            
            // Convert FormData to JSON
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });
            
            // Add contact IDs and schedule information
            data.contact_ids = selectedContacts;
            data.scheduled = document.getElementById('enableSchedule').checked;
            
            if (!data.scheduled) {
                delete data.schedule_time;
            }
            
            // Send request to send message
            fetch('/message/send_to_contacts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('sendMessageModal'));
                    modal.hide();
                    form.reset();
                    
                    // Show success message
                    if (data.scheduled) {
                        showAlert('success', 'Message scheduled successfully!');
                    } else {
                        showAlert('success', 'Message sent successfully!');
                    }
                } else {
                    showAlert('danger', data.error || 'Failed to send message.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('danger', 'An error occurred while sending the message.');
            });
        });
        
        // Add event delegation for contact actions
        document.getElementById('contactsTable').addEventListener('click', function(e) {
            // Edit contact button
            if (e.target.closest('.edit-contact-btn')) {
                const contactId = e.target.closest('.edit-contact-btn').getAttribute('data-contact-id');
                editContact(contactId);
            }
            
            // Delete contact button
            if (e.target.closest('.delete-contact-btn')) {
                const contactId = e.target.closest('.delete-contact-btn').getAttribute('data-contact-id');
                const contactName = e.target.closest('tr').querySelector('td:nth-child(2)').textContent;
                deleteContact(contactId, contactName);
            }
            
            // Send message button
            if (e.target.closest('.send-message-btn')) {
                const contactId = e.target.closest('.send-message-btn').getAttribute('data-contact-id');
                const contactName = e.target.closest('tr').querySelector('td:nth-child(2)').textContent;
                sendMessageToContact(contactId, contactName);
            }
        });
        
        // Functions
        
        function loadContacts(searchTerm = null, group = null, page = 1) {
            // Show loading row
            document.getElementById('loadingRow').style.display = 'table-row';
            
            // Build URL with search and filter parameters
            let url = '/contact/api/list?page=' + page;
            
            if (searchTerm) {
                url += `&search=${encodeURIComponent(searchTerm)}`;
            }
            
            if (group && group !== 'all') {
                url += `&group=${encodeURIComponent(group)}`;
            }
            
            // Fetch contacts
            fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const tableBody = document.getElementById('contactsTable').getElementsByTagName('tbody')[0];
                    const contactCount = document.getElementById('contactCount');
                    const pagination = document.getElementById('contactsPagination');
                    
                    // Clear table body except loading row
                    Array.from(tableBody.children).forEach(child => {
                        if (child.id !== 'loadingRow') {
                            tableBody.removeChild(child);
                        }
                    });
                    
                    // Hide loading row
                    document.getElementById('loadingRow').style.display = 'none';
                    
                    // Update contact count
                    contactCount.textContent = data.total;
                    
                    // Add contacts to table
                    if (data.contacts.length > 0) {
                        data.contacts.forEach(contact => {
                            const row = tableBody.insertRow();
                            
                            const checkboxCell = row.insertCell(0);
                            checkboxCell.innerHTML = `
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="${contact.id}">
                                    <label class="form-check-label"></label>
                                </div>
                            `;
                            
                            row.insertCell(1).textContent = contact.name;
                            row.insertCell(2).textContent = contact.phone;
                            row.insertCell(3).textContent = contact.email || '-';
                            row.insertCell(4).textContent = contact.groups.join(', ') || 'Default';
                            row.insertCell(5).textContent = formatDate(contact.created_at);
                            
                            const actionsCell = row.insertCell(6);
                            actionsCell.innerHTML = `
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary edit-contact-btn" data-contact-id="${contact.id}">
                                        <i class="align-middle" data-feather="edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-info send-message-btn" data-contact-id="${contact.id}">
                                        <i class="align-middle" data-feather="message-square"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-contact-btn" data-contact-id="${contact.id}">
                                        <i class="align-middle" data-feather="trash-2"></i>
                                    </button>
                                </div>
                            `;
                        });
                        
                        // Re-initialize Feather icons
                        feather.replace();
                    } else {
                        const row = tableBody.insertRow();
                        const cell = row.insertCell(0);
                        cell.colSpan = 7;
                        cell.className = 'text-center';
                        cell.textContent = searchTerm || group !== 'all' ? 'No contacts found matching your criteria.' : 'No contacts found. Add your first contact!';
                    }
                    
                    // Generate pagination
                    generatePagination(pagination, data.page, data.pages, searchTerm, group);
                    
                    // Reset select all checkbox
                    document.getElementById('selectAllContacts').checked = false;
                    updateBulkActionState();
                } else {
                    showAlert('danger', data.error || 'Failed to load contacts.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('danger', 'An error occurred while loading contacts.');
                document.getElementById('loadingRow').style.display = 'none';
            });
        }
        
        function loadGroups() {
            fetch('/contact/api/list_groups')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const filterGroup = document.getElementById('filterGroup');
                    const contactGroup = document.getElementById('contactGroup');
                    
                    // Clear existing options except the first one
                    while (filterGroup.options.length > 1) {
                        filterGroup.remove(1);
                    }
                    
                    while (contactGroup.options.length > 1) {
                        contactGroup.remove(1);
                    }
                    
                    // Add groups to selects
                    if (data.groups.length > 0) {
                        data.groups.forEach(group => {
                            // Add to filter select
                            const filterOption = document.createElement('option');
                            filterOption.value = group.name;
                            filterOption.textContent = group.name;
                            filterGroup.appendChild(filterOption);
                            
                            // Add to contact form select
                            const contactOption = document.createElement('option');
                            contactOption.value = group.name;
                            contactOption.textContent = group.name;
                            contactGroup.appendChild(contactOption);
                        });
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
        
        function loadGroupsForModal(selectId) {
            fetch('/contact/api/list_groups')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const select = document.getElementById(selectId);
                    
                    // Clear existing options except the first one
                    while (select.options.length > 1) {
                        select.remove(1);
                    }
                    
                    // Add groups to select
                    if (data.groups.length > 0) {
                        data.groups.forEach(group => {
                            const option = document.createElement('option');
                            option.value = group.name;
                            option.textContent = group.name;
                            select.appendChild(option);
                        });
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
        
        function loadMessageTemplates() {
            fetch('/message/templates')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const templateSelect = document.getElementById('messageTemplate');
                    
                    // Clear existing options except the first one
                    while (templateSelect.options.length > 1) {
                        templateSelect.remove(1);
                    }
                    
                    // Add templates to select
                    if (data.templates.length > 0) {
                        data.templates.forEach(template => {
                            const option = document.createElement('option');
                            option.value = template.id;
                            option.textContent = template.name;
                            templateSelect.appendChild(option);
                        });
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
        
        function editContact(contactId) {
            // Fetch contact details
            fetch(`/contact/${contactId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const contact = data.contact;
                    
                    // Update modal title
                    document.getElementById('addContactModalLabel').textContent = 'Edit Contact';
                    
                    // Populate form fields
                    document.getElementById('contactId').value = contact.id;
                    document.getElementById('contactName').value = contact.name;
                    document.getElementById('contactPhone').value = contact.phone.replace(/^\+/, ''); // Remove + from phone
                    document.getElementById('contactEmail').value = contact.email || '';
                    document.getElementById('contactNotes').value = contact.notes || '';
                    
                    // Set group if available
                    const groupSelect = document.getElementById('contactGroup');
                    if (contact.groups && contact.groups.length > 0) {
                        // Try to find the group in the select
                        const groupOption = Array.from(groupSelect.options).find(option => option.value === contact.groups[0]);
                        
                        if (groupOption) {
                            groupSelect.value = contact.groups[0];
                        } else {
                            // If group not found in select, add it
                            const option = document.createElement('option');
                            option.value = contact.groups[0];
                            option.textContent = contact.groups[0];
                            groupSelect.appendChild(option);
                            groupSelect.value = contact.groups[0];
                        }
                    } else {
                        groupSelect.value = 'default';
                    }
                    
                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('addContactModal'));
                    modal.show();
                } else {
                    showAlert('danger', data.error || 'Failed to load contact details.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('danger', 'An error occurred while loading contact details.');
            });
        }
        
        function deleteContact(contactId, contactName) {
            // Update delete confirmation message
            document.getElementById('deleteConfirmMessage').textContent = `Are you sure you want to delete the contact "${contactName}"? This action cannot be undone.`;
            
            // Reset confirmation checkbox
            document.getElementById('confirmDelete').checked = false;
            document.getElementById('confirmDeleteBtn').disabled = true;
            
            // Set up delete button click handler
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            
            // Remove existing event listeners
            const newConfirmDeleteBtn = confirmDeleteBtn.cloneNode(true);
            confirmDeleteBtn.parentNode.replaceChild(newConfirmDeleteBtn, confirmDeleteBtn);
            
            // Add new event listener
            newConfirmDeleteBtn.addEventListener('click', function() {
                // Send request to delete contact
                fetch(`/contact/delete/${contactId}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Close modal and reload contacts
                        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
                        modal.hide();
                        loadContacts();
                        
                        // Show success message
                        showAlert('success', 'Contact deleted successfully!');
                    } else {
                        showAlert('danger', data.error || 'Failed to delete contact.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('danger', 'An error occurred while deleting the contact.');
                });
            });
            
            // Show delete confirmation modal
            const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            modal.show();
        }
        
        function sendMessageToContact(contactId, contactName) {
            // Update message recipient info
            document.getElementById('messageRecipientCount').textContent = '1';
            document.getElementById('sendMessageInfo').textContent = `You are about to send a message to ${contactName}.`;
            
            // Load message templates
            loadMessageTemplates();
            
            // Reset message form
            document.getElementById('sendMessageForm').reset();
            document.getElementById('enableSchedule').checked = false;
            document.getElementById('scheduleTimeContainer').style.display = 'none';
            
            // Set up send button click handler
            const sendMessageBtn = document.getElementById('sendMessageBtn');
            
            // Remove existing event listeners
            const newSendMessageBtn = sendMessageBtn.cloneNode(true);
            sendMessageBtn.parentNode.replaceChild(newSendMessageBtn, sendMessageBtn);
            
            // Add new event listener
            newSendMessageBtn.addEventListener('click', function() {
                const form = document.getElementById('sendMessageForm');
                
                // Validate form
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                
                const formData = new FormData(form);
                
                // Convert FormData to JSON
                const data = {};
                formData.forEach((value, key) => {
                    data[key] = value;
                });
                
                // Add contact ID and schedule information
                data.contact_ids = [contactId];
                data.scheduled = document.getElementById('enableSchedule').checked;
                
                if (!data.scheduled) {
                    delete data.schedule_time;
                }
                
                // Send request to send message
                fetch('/message/send_to_contacts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Close modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('sendMessageModal'));
                        modal.hide();
                        form.reset();
                        
                        // Show success message
                        if (data.scheduled) {
                            showAlert('success', 'Message scheduled successfully!');
                        } else {
                            showAlert('success', 'Message sent successfully!');
                        }
                    } else {
                        showAlert('danger', data.error || 'Failed to send message.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('danger', 'An error occurred while sending the message.');
                });
            });
            
            // Show send message modal
            const modal = new bootstrap.Modal(document.getElementById('sendMessageModal'));
            modal.show();
        }
        
        function getSelectedContacts() {
            const checkboxes = document.querySelectorAll('#contactsTable tbody input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(checkbox => checkbox.value);
        }
        
        function updateBulkActionState() {
            const selectedContacts = getSelectedContacts();
            const bulkActionsDropdown = document.getElementById('bulkActionsDropdown');
            
            if (selectedContacts.length > 0) {
                bulkActionsDropdown.classList.remove('disabled');
                bulkActionsDropdown.textContent = `Bulk Actions (${selectedContacts.length})`;
            } else {
                bulkActionsDropdown.classList.add('disabled');
                bulkActionsDropdown.textContent = 'Bulk Actions';
            }
        }
        
        function generatePagination(paginationElement, currentPage, totalPages, searchTerm, group) {
            // Clear pagination
            paginationElement.innerHTML = '';
            
            if (totalPages <= 1) {
                return;
            }
            
            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            const prevLink = document.createElement('a');
            prevLink.className = 'page-link';
            prevLink.href = '#';
            prevLink.setAttribute('aria-label', 'Previous');
            prevLink.innerHTML = '<span aria-hidden="true">&laquo;</span>';
            prevLi.appendChild(prevLink);
            paginationElement.appendChild(prevLi);
            
            if (currentPage > 1) {
                prevLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    loadContacts(searchTerm, group, currentPage - 1);
                });
            }
            
            // Page numbers
            const maxPages = 5; // Maximum number of page links to show
            let startPage = Math.max(1, currentPage - Math.floor(maxPages / 2));
            let endPage = Math.min(totalPages, startPage + maxPages - 1);
            
            if (endPage - startPage + 1 < maxPages) {
                startPage = Math.max(1, endPage - maxPages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
                const pageLink = document.createElement('a');
                pageLink.className = 'page-link';
                pageLink.href = '#';
                pageLink.textContent = i;
                pageLi.appendChild(pageLink);
                paginationElement.appendChild(pageLi);
                
                if (i !== currentPage) {
                    pageLink.addEventListener('click', function(e) {
                        e.preventDefault();
                        loadContacts(searchTerm, group, i);
                    });
                }
            }
            
            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            const nextLink = document.createElement('a');
            nextLink.className = 'page-link';
            nextLink.href = '#';
            nextLink.setAttribute('aria-label', 'Next');
            nextLink.innerHTML = '<span aria-hidden="true">&raquo;</span>';
            nextLi.appendChild(nextLink);
            paginationElement.appendChild(nextLi);
            
            if (currentPage < totalPages) {
                nextLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    loadContacts(searchTerm, group, currentPage + 1);
                });
            }
        }
        
        function formatDate(dateString) {
            if (!dateString) return '-';
            
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }
        
        function showAlert(type, message) {
            // Create alert element
            const alertElement = document.createElement('div');
            alertElement.className = `alert alert-${type} alert-dismissible fade show`;
            alertElement.setAttribute('role', 'alert');
            alertElement.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Add alert to the top of the page
            const container = document.querySelector('.container-fluid');
            container.insertBefore(alertElement, container.firstChild);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                const bsAlert = new bootstrap.Alert(alertElement);
                bsAlert.close();
            }, 5000);
        }
        
        // Reset contact form when modal is hidden
        document.getElementById('addContactModal').addEventListener('hidden.bs.modal', function() {
            document.getElementById('contactForm').reset();
            document.getElementById('contactId').value = '';
            document.getElementById('addContactModalLabel').textContent = 'Add New Contact';
        });
    });
</script>
{% endblock %}