{% extends "dashboard.html" %}

{% block content %}
<div class="container-fluid p-0">
    <div class="row mb-2 mb-xl-3">
        <div class="col-auto d-none d-sm-block">
            <h1 class="h3 mb-3">Connect WhatsApp</h1>
        </div>

        <div class="col-auto ms-auto text-end mt-n1">
            <a href="{{ url_for('selenium_check.index') }}" class="btn btn-warning">
                <i class="align-middle" data-feather="check-circle"></i> Check Selenium
            </a>
            <a href="{{ url_for('whatsapp_web.index') }}" class="btn btn-light">
                <i class="align-middle" data-feather="arrow-left"></i> Back to WhatsApp
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-12 col-lg-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Connect WhatsApp Device</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <form id="whatsappConnectForm" method="POST" action="{{ url_for('whatsapp_web.connect_device') }}">
                                <div class="mb-3">
                                    <label for="deviceName" class="form-label">Device Name</label>
                                    <input type="text" class="form-control" id="deviceName" name="device_name" required placeholder="e.g. My Business Phone">
                                    <div class="form-text">Give this WhatsApp connection a name to identify it later.</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="sessionName" class="form-label">Session</label>
                                    <select class="form-select" id="sessionName" name="session_name" required>
                                        <option value="" selected disabled>Select a session</option>
                                        <!-- Sessions will be populated dynamically -->
                                    </select>
                                    <div class="form-text">Select the session to use for this WhatsApp connection.</div>
                                </div>

                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="align-middle" data-feather="link"></i> Connect Device
                                    </button>
                                </div>
                                
                                <div class="mt-3 text-center">
                                    <p>Don't have a session yet?</p>
                                    <a href="{{ url_for('whatsapp_web.generate_qr_page') }}" class="btn btn-outline-primary">
                                        <i class="align-middle" data-feather="qr-code"></i> Generate New QR Code
                                    </a>
                                </div>
                            </form>
                        </div>
                        <div class="col-md-6 text-center">
                            <div id="initialInstructions">
                                <div class="mb-4">
                                    <i class="align-middle" data-feather="smartphone" style="width: 64px; height: 64px;"></i>
                                </div>
                                <h4>Connect Your WhatsApp</h4>
                                <p class="text-muted">Select a session and enter a device name to connect your WhatsApp device.</p>
                                <div class="alert alert-info mt-3">
                                    <i class="align-middle" data-feather="info"></i>
                                    If you haven't created a session yet, click on "Generate New QR Code" to create one.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Connection Instructions</h5>
                </div>
                <div class="card-body">
                    <ol class="mb-0">
                        <li class="mb-2">If you don't have a WhatsApp session yet, click on <strong>"Generate New QR Code"</strong> to create one.</li>
                        <li class="mb-2">Once you have created a session by scanning the QR code with your phone, return to this page.</li>
                        <li class="mb-2">Enter a name for this WhatsApp connection.</li>
                        <li class="mb-2">Select the session you created from the dropdown.</li>
                        <li class="mb-2">Click the <strong>"Connect Device"</strong> button.</li>
                        <li>Your device will now be connected to the WhatsApp session.</li>
                    </ol>
                    
                    <div class="alert alert-info mt-3">
                        <i class="align-middle" data-feather="info"></i>
                        <strong>Note:</strong> You need to create a session first by generating and scanning a QR code before you can connect a device.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const sessionSelect = document.getElementById('sessionName');
        const connectForm = document.getElementById('whatsappConnectForm');
        
        // Load sessions
        fetch('/api/sessions/whatsapp')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.sessions.length > 0) {
                    data.sessions.forEach(session => {
                        const option = document.createElement('option');
                        option.value = session.name;
                        option.textContent = session.name;
                        sessionSelect.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "No sessions available";
                    sessionSelect.appendChild(option);
                    document.querySelector('button[type="submit"]').disabled = true;
                }
            })
            .catch(error => {
                console.error('Error loading sessions:', error);
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "Error loading sessions";
                sessionSelect.appendChild(option);
                document.querySelector('button[type="submit"]').disabled = true;
            });
        
        // Form validation
        connectForm.addEventListener('submit', function(event) {
            const deviceName = document.getElementById('deviceName').value.trim();
            const sessionName = sessionSelect.value;
            
            if (!deviceName) {
                event.preventDefault();
                alert('Please enter a device name');
                return false;
            }
            
            if (!sessionName) {
                event.preventDefault();
                alert('Please select a session');
                return false;
            }
            
            return true;
        });
    });
</script>
{% endblock %}