{% extends "dashboard.html" %}

{% block content %}
<div class="container-fluid p-0">
    <div class="row mb-2 mb-xl-3">
        <div class="col-auto d-none d-sm-block">
            <h1 class="h3 mb-3">WhatsApp Settings</h1>
        </div>

        <div class="col-auto ms-auto text-end mt-n1">
            <a href="{{ url_for('selenium_check.index') }}" class="btn btn-warning">
                <i class="align-middle" data-feather="check-circle"></i> Check Selenium
            </a>
            <a href="{{ url_for('whatsapp_web.index') }}" class="btn btn-light">
                <i class="align-middle" data-feather="arrow-left"></i> Back to WhatsApp
            </a>
        </div>
    </div>

    <div class="row">
        <!-- General Settings Card -->
        <div class="col-12 col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">General Settings</h5>
                </div>
                <div class="card-body">
                    <form id="generalSettingsForm">
                        <input type="hidden" name="settings_type" value="general">
                        
                        <div class="mb-3">
                            <label class="form-label">Default Message Format</label>
                            <div class="form-check form-switch mb-1">
                                <input class="form-check-input" type="checkbox" id="enableRichText" name="enable_rich_text" {% if settings.enable_rich_text %}checked{% endif %}>
                                <label class="form-check-label" for="enableRichText">Enable Rich Text Formatting</label>
                            </div>
                            <div class="form-text">When enabled, messages can include bold, italic, and other formatting.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Message Delivery</label>
                            <div class="form-check form-switch mb-1">
                                <input class="form-check-input" type="checkbox" id="enableReadReceipts" name="enable_read_receipts" {% if settings.enable_read_receipts %}checked{% endif %}>
                                <label class="form-check-label" for="enableReadReceipts">Enable Read Receipts</label>
                            </div>
                            <div class="form-text">When enabled, you'll be notified when recipients read your messages.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="messageRetention" class="form-label">Message Retention Period</label>
                            <select class="form-select" id="messageRetention" name="message_retention">
                                <option value="7" {% if settings.message_retention == 7 %}selected{% endif %}>7 days</option>
                                <option value="30" {% if settings.message_retention == 30 %}selected{% endif %}>30 days</option>
                                <option value="90" {% if settings.message_retention == 90 %}selected{% endif %}>90 days</option>
                                <option value="180" {% if settings.message_retention == 180 %}selected{% endif %}>180 days</option>
                                <option value="365" {% if settings.message_retention == 365 %}selected{% endif %}>1 year</option>
                                <option value="0" {% if settings.message_retention == 0 %}selected{% endif %}>Forever</option>
                            </select>
                            <div class="form-text">How long to keep message history before automatic deletion.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="defaultReplyTimeout" class="form-label">Default Reply Timeout</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="defaultReplyTimeout" name="default_reply_timeout" value="{{ settings.default_reply_timeout|default(24) }}" min="1" max="72">
                                <span class="input-group-text">hours</span>
                            </div>
                            <div class="form-text">Maximum time to wait for a reply before marking conversation as inactive.</div>
                        </div>
                        
                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-primary">Save General Settings</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Notification Settings Card -->
        <div class="col-12 col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Notification Settings</h5>
                </div>
                <div class="card-body">
                    <form id="notificationSettingsForm">
                        <input type="hidden" name="settings_type" value="notification">
                        
                        <div class="mb-3">
                            <label class="form-label">Email Notifications</label>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="notifyNewMessages" name="notify_new_messages" {% if settings.notify_new_messages %}checked{% endif %}>
                                <label class="form-check-label" for="notifyNewMessages">New Messages</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="notifyDeliveryFailures" name="notify_delivery_failures" {% if settings.notify_delivery_failures %}checked{% endif %}>
                                <label class="form-check-label" for="notifyDeliveryFailures">Delivery Failures</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="notifySessionExpiry" name="notify_session_expiry" {% if settings.notify_session_expiry %}checked{% endif %}>
                                <label class="form-check-label" for="notifySessionExpiry">Session Expiry</label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="notificationEmail" class="form-label">Notification Email</label>
                            <input type="email" class="form-control" id="notificationEmail" name="notification_email" value="{{ settings.notification_email }}" placeholder="your@email.com">
                            <div class="form-text">Email address to receive WhatsApp notifications.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">In-App Notifications</label>
                            <div class="form-check form-switch mb-1">
                                <input class="form-check-input" type="checkbox" id="enableInAppNotifications" name="enable_in_app_notifications" {% if settings.enable_in_app_notifications %}checked{% endif %}>
                                <label class="form-check-label" for="enableInAppNotifications">Enable In-App Notifications</label>
                            </div>
                            <div class="form-text">Show notifications within the application interface.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Quiet Hours</label>
                            <div class="row g-2">
                                <div class="col-6">
                                    <label for="quietHoursStart" class="form-label">Start</label>
                                    <input type="time" class="form-control" id="quietHoursStart" name="quiet_hours_start" value="{{ settings.quiet_hours_start|default('22:00') }}">
                                </div>
                                <div class="col-6">
                                    <label for="quietHoursEnd" class="form-label">End</label>
                                    <input type="time" class="form-control" id="quietHoursEnd" name="quiet_hours_end" value="{{ settings.quiet_hours_end|default('07:00') }}">
                                </div>
                            </div>
                            <div class="form-text">During quiet hours, notifications will be muted.</div>
                        </div>
                        
                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-primary">Save Notification Settings</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Auto-Reply Settings Card -->
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Auto-Reply Settings</h5>
                    <div>
                        <button type="button" class="btn btn-sm btn-primary" id="addAutoReplyBtn">
                            <i class="align-middle" data-feather="plus"></i> Add Auto-Reply
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="enableAutoReplies" name="enable_auto_replies" {% if settings.enable_auto_replies %}checked{% endif %}>
                            <label class="form-check-label" for="enableAutoReplies">Enable Auto-Replies</label>
                        </div>
                        <div class="form-text">When enabled, automatic responses will be sent based on the rules below.</div>
                    </div>
                    
                    {% if auto_replies and auto_replies|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Trigger Type</th>
                                    <th>Trigger</th>
                                    <th>Response</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for reply in auto_replies %}
                                <tr>
                                    <td>{{ reply.name }}</td>
                                    <td>
                                        {% if reply.trigger_type == 'keyword' %}
                                        <span class="badge bg-primary trigger-badge">Keyword</span>
                                        {% elif reply.trigger_type == 'away' %}
                                        <span class="badge bg-warning trigger-badge">Away Message</span>
                                        {% elif reply.trigger_type == 'welcome' %}
                                        <span class="badge bg-info trigger-badge">Welcome Message</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if reply.trigger_type == 'keyword' %}
                                        {{ reply.trigger_keyword }}
                                        {% elif reply.trigger_type == 'away' %}
                                        After {{ reply.away_timeout }} hours
                                        {% elif reply.trigger_type == 'welcome' %}
                                        New conversation
                                        {% endif %}
                                    </td>
                                    <td>{{ reply.response|truncate(30) }}</td>
                                    <td>
                                        {% if reply.is_active %}
                                        <span class="badge bg-success">Active</span>
                                        {% else %}
                                        <span class="badge bg-secondary">Inactive</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-info dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="align-middle" data-feather="more-vertical"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item edit-auto-reply" href="#" data-id="{{ reply.id }}">Edit</a></li>
                                                <li><a class="dropdown-item toggle-auto-reply" href="#" data-id="{{ reply.id }}" data-active="{{ reply.is_active|int }}">{% if reply.is_active %}Deactivate{% else %}Activate{% endif %}</a></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li><a class="dropdown-item text-danger delete-auto-reply" href="#" data-id="{{ reply.id }}" data-name="{{ reply.name }}">Delete</a></li>
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <div class="mb-3">
                            <i class="align-middle" data-feather="message-square" style="width: 48px; height: 48px;"></i>
                        </div>
                        <h4>No Auto-Replies Configured</h4>
                        <p class="text-muted">Create auto-replies to automatically respond to incoming messages.</p>
                        <button type="button" class="btn btn-primary mt-2" id="addFirstAutoReplyBtn">
                            <i class="align-middle" data-feather="plus"></i> Add Your First Auto-Reply
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- WhatsApp JS -->
<script src="{{ url_for('static', filename='js/modules/whatsapp/whatsapp.js') }}"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Initialize SweetAlert2 with theme
        initSweetAlert2Theme();
        
        // Handle trigger type change for new auto-reply
        let triggerType, keywordFields, awayFields;
        
        // Handle general settings form submission
        const generalSettingsForm = document.getElementById('generalSettingsForm');
        if (generalSettingsForm) {
            generalSettingsForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const formData = new FormData(generalSettingsForm);
                
                fetch('{{ url_for("whatsapp_web.update_settings") }}', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Settings Saved',
                            text: 'General settings have been updated successfully.'
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: data.error || 'Failed to update settings'
                        });
                    }
                })
                .catch(error => {
                    console.error('Error saving settings:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'An error occurred while saving settings. Please try again.'
                    });
                });
            });
        }
        
        // Handle notification settings form submission
        const notificationSettingsForm = document.getElementById('notificationSettingsForm');
        if (notificationSettingsForm) {
            notificationSettingsForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const formData = new FormData(notificationSettingsForm);
                
                fetch('{{ url_for("whatsapp_web.update_settings") }}', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Settings Saved',
                            text: 'Notification settings have been updated successfully.'
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: data.error || 'Failed to update settings'
                        });
                    }
                })
                .catch(error => {
                    console.error('Error saving settings:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'An error occurred while saving settings. Please try again.'
                    });
                });
            });
        }
        
        // Toggle auto-replies status
        const enableAutoReplies = document.getElementById('enableAutoReplies');
        if (enableAutoReplies) {
            enableAutoReplies.addEventListener('change', function() {
                toggleAutoReplyStatus('all', this.checked ? 1 : 0);
            });
        }
        
        // Add auto-reply button
        const addAutoReplyBtn = document.getElementById('addAutoReplyBtn');
        const addFirstAutoReplyBtn = document.getElementById('addFirstAutoReplyBtn');
        
        function showAddAutoReplyModal() {
            Swal.fire({
                title: 'Add Auto-Reply',
                html: `
                    <form id="swalAddAutoReplyForm" class="text-start">
                        <div class="mb-3">
                            <label for="replyName" class="form-label">Name</label>
                            <input type="text" class="form-control" id="replyName" name="name" required placeholder="e.g. Welcome Message">
                        </div>
                        
                        <div class="mb-3">
                            <label for="triggerType" class="form-label">Trigger Type</label>
                            <select class="form-select" id="triggerType" name="trigger_type" required>
                                <option value="" selected disabled>Select trigger type</option>
                                <option value="keyword">Keyword</option>
                                <option value="welcome">Welcome Message (New Conversation)</option>
                                <option value="away">Away Message (No Response)</option>
                            </select>
                        </div>
                        
                        <div id="keywordFields" class="mb-3 d-none">
                            <label for="triggerKeyword" class="form-label">Trigger Keyword</label>
                            <input type="text" class="form-control" id="triggerKeyword" name="trigger_keyword" placeholder="e.g. help, info, hours">
                            <div class="form-text">Comma-separated keywords that will trigger this auto-reply.</div>
                        </div>
                        
                        <div id="awayFields" class="mb-3 d-none">
                            <label for="awayTimeout" class="form-label">Away Timeout (hours)</label>
                            <input type="number" class="form-control" id="awayTimeout" name="away_timeout" min="1" max="72" value="24">
                            <div class="form-text">Send this message when there's no response for this many hours.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="responseMessage" class="form-label">Response Message</label>
                            <textarea class="form-control" id="responseMessage" name="response" rows="5" required placeholder="Enter your auto-reply message here..."></textarea>
                            <div class="form-text">
                                You can use these variables in your message:
                                <code>{first_name}</code>, <code>{last_name}</code>, <code>{phone}</code>, <code>{date}</code>, <code>{time}</code>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="isActive" name="is_active" checked>
                                <label class="form-check-label" for="isActive">Active</label>
                            </div>
                        </div>
                    </form>
                `,
                showCancelButton: true,
                confirmButtonText: 'Save Auto-Reply',
                cancelButtonText: 'Cancel',
                didOpen: () => {
                    // Handle trigger type change
                    triggerType = document.getElementById('triggerType');
                    keywordFields = document.getElementById('keywordFields');
                    awayFields = document.getElementById('awayFields');
                    
                    if (triggerType) {
                        triggerType.addEventListener('change', function() {
                            if (this.value === 'keyword') {
                                keywordFields.classList.remove('d-none');
                                awayFields.classList.add('d-none');
                            } else if (this.value === 'away') {
                                keywordFields.classList.add('d-none');
                                awayFields.classList.remove('d-none');
                            } else {
                                keywordFields.classList.add('d-none');
                                awayFields.classList.add('d-none');
                            }
                        });
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const form = document.getElementById('swalAddAutoReplyForm');
                    const formData = new FormData(form);
                    
                    fetch('{{ url_for("whatsapp_web.add_auto_reply") }}', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Auto-Reply Added',
                                text: 'The auto-reply has been added successfully.',
                                confirmButtonText: 'OK'
                            }).then(() => {
                                window.location.reload();
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: data.error || 'Failed to add auto-reply'
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error adding auto-reply:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'An error occurred while adding the auto-reply. Please try again.'
                        });
                    });
                }
            });
        }
        
        if (addAutoReplyBtn) {
            addAutoReplyBtn.addEventListener('click', showAddAutoReplyModal);
        }
        
        if (addFirstAutoReplyBtn) {
            addFirstAutoReplyBtn.addEventListener('click', showAddAutoReplyModal);
        }
        
        // Edit auto-reply
        const editAutoReplyBtns = document.querySelectorAll('.edit-auto-reply');
        editAutoReplyBtns.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const replyId = this.getAttribute('data-id');
                
                // Fetch auto-reply data
                fetch(`/api/auto-reply/${replyId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const reply = data.auto_reply;
                            
                            Swal.fire({
                                title: 'Edit Auto-Reply',
                                html: `
                                    <form id="swalEditAutoReplyForm" class="text-start">
                                        <div class="mb-3">
                                            <label for="editReplyName" class="form-label">Name</label>
                                            <input type="text" class="form-control" id="editReplyName" name="name" required value="${reply.name}">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="editTriggerType" class="form-label">Trigger Type</label>
                                            <select class="form-select" id="editTriggerType" name="trigger_type" required>
                                                <option value="keyword" ${reply.trigger_type === 'keyword' ? 'selected' : ''}>Keyword</option>
                                                <option value="welcome" ${reply.trigger_type === 'welcome' ? 'selected' : ''}>Welcome Message (New Conversation)</option>
                                                <option value="away" ${reply.trigger_type === 'away' ? 'selected' : ''}>Away Message (No Response)</option>
                                            </select>
                                        </div>
                                        
                                        <div id="editKeywordFields" class="mb-3 ${reply.trigger_type !== 'keyword' ? 'd-none' : ''}">
                                            <label for="editTriggerKeyword" class="form-label">Trigger Keyword</label>
                                            <input type="text" class="form-control" id="editTriggerKeyword" name="trigger_keyword" value="${reply.trigger_keyword || ''}">
                                            <div class="form-text">Comma-separated keywords that will trigger this auto-reply.</div>
                                        </div>
                                        
                                        <div id="editAwayFields" class="mb-3 ${reply.trigger_type !== 'away' ? 'd-none' : ''}">
                                            <label for="editAwayTimeout" class="form-label">Away Timeout (hours)</label>
                                            <input type="number" class="form-control" id="editAwayTimeout" name="away_timeout" min="1" max="72" value="${reply.away_timeout || 24}">
                                            <div class="form-text">Send this message when there's no response for this many hours.</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="editResponseMessage" class="form-label">Response Message</label>
                                            <textarea class="form-control" id="editResponseMessage" name="response" rows="5" required>${reply.response}</textarea>
                                            <div class="form-text">
                                                You can use these variables in your message:
                                                <code>{first_name}</code>, <code>{last_name}</code>, <code>{phone}</code>, <code>{date}</code>, <code>{time}</code>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="editIsActive" name="is_active" ${reply.is_active ? 'checked' : ''}>
                                                <label class="form-check-label" for="editIsActive">Active</label>
                                            </div>
                                        </div>
                                    </form>
                                `,
                                showCancelButton: true,
                                confirmButtonText: 'Update Auto-Reply',
                                cancelButtonText: 'Cancel',
                                didOpen: () => {
                                    // Handle trigger type change
                                    const editTriggerType = document.getElementById('editTriggerType');
                                    const editKeywordFields = document.getElementById('editKeywordFields');
                                    const editAwayFields = document.getElementById('editAwayFields');
                                    
                                    if (editTriggerType) {
                                        editTriggerType.addEventListener('change', function() {
                                            if (this.value === 'keyword') {
                                                editKeywordFields.classList.remove('d-none');
                                                editAwayFields.classList.add('d-none');
                                            } else if (this.value === 'away') {
                                                editKeywordFields.classList.add('d-none');
                                                editAwayFields.classList.remove('d-none');
                                            } else {
                                                editKeywordFields.classList.add('d-none');
                                                editAwayFields.classList.add('d-none');
                                            }
                                        });
                                    }
                                }
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    const form = document.getElementById('swalEditAutoReplyForm');
                                    const formData = new FormData(form);
                                    
                                    fetch(`/whatsapp/update-auto-reply/${replyId}`, {
                                        method: 'POST',
                                        body: formData
                                    })
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.success) {
                                            Swal.fire({
                                                icon: 'success',
                                                title: 'Auto-Reply Updated',
                                                text: 'The auto-reply has been updated successfully.',
                                                confirmButtonText: 'OK'
                                            }).then(() => {
                                                window.location.reload();
                                            });
                                        } else {
                                            Swal.fire({
                                                icon: 'error',
                                                title: 'Error',
                                                text: data.error || 'Failed to update auto-reply'
                                            });
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error updating auto-reply:', error);
                                        Swal.fire({
                                            icon: 'error',
                                            title: 'Error',
                                            text: 'An error occurred while updating the auto-reply. Please try again.'
                                        });
                                    });
                                }
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: data.error || 'Failed to load auto-reply data'
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error loading auto-reply data:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'An error occurred while loading the auto-reply data. Please try again.'
                        });
                    });
            });
        });
        
        // Toggle individual auto-reply status
        const toggleAutoReplyBtns = document.querySelectorAll('.toggle-auto-reply');
        toggleAutoReplyBtns.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const replyId = this.getAttribute('data-id');
                const currentStatus = parseInt(this.getAttribute('data-active'));
                const newStatus = currentStatus === 1 ? 0 : 1;
                const statusText = newStatus === 1 ? 'activate' : 'deactivate';
                
                Swal.fire({
                    title: `${newStatus === 1 ? 'Activate' : 'Deactivate'} Auto-Reply?`,
                    text: `Are you sure you want to ${statusText} this auto-reply?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: `Yes, ${statusText} it`,
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        toggleAutoReplyStatus(replyId, newStatus);
                    }
                });
            });
        });
        
        // Delete auto-reply
        const deleteAutoReplyBtns = document.querySelectorAll('.delete-auto-reply');
        deleteAutoReplyBtns.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const replyId = this.getAttribute('data-id');
                const replyName = this.getAttribute('data-name');
                
                Swal.fire({
                    title: 'Delete Auto-Reply?',
                    html: `Are you sure you want to delete the auto-reply <strong>"${replyName}"</strong>?<br><br>This action cannot be undone.`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, delete it',
                    cancelButtonText: 'Cancel',
                    confirmButtonColor: '#dc3545'
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch(`/whatsapp/delete-auto-reply/${replyId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Deleted!',
                                    text: 'The auto-reply has been deleted.',
                                    confirmButtonText: 'OK'
                                }).then(() => {
                                    window.location.reload();
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: data.error || 'Failed to delete auto-reply'
                                });
                            }
                        })
                        .catch(error => {
                            console.error('Error deleting auto-reply:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'An error occurred while deleting the auto-reply. Please try again.'
                            });
                        });
                    }
                });
            });
        });
    });
    
    // Function to toggle auto-reply status
    function toggleAutoReplyStatus(replyId, newStatus) {
        fetch(`/whatsapp/toggle-auto-reply-status/${replyId}/${newStatus}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Status Updated',
                    text: data.message || 'Auto-reply status has been updated.',
                    confirmButtonText: 'OK'
                }).then(() => {
                    window.location.reload();
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.error || 'Failed to update status'
                });
            }
        })
        .catch(error => {
            console.error('Error toggling status:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'An error occurred while updating the status. Please try again.'
            });
        });
    }
</script>
{% endblock %}